<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="person-card.html">

<polymer-element name="person-list" attributes="query">
  <template>
    <style>
    :host {
      display: block;
      width: 100%;
      height:100%;
    }
    .result {
      margin-bottom:15px;
      padding:10px;
    }
    </style>


    <core-ajax id="people_count"
      auto
      url='../api/people/count?where={"CID":{"like":"{{query}}"}}'
      on-core-response="{{countReturn}}"
      handleAs="json">
    </core-ajax>

    <core-ajax id="ajax"
      auto
      url='../api/people?filter={"limit":10,"skip":{{page}},"where":{"CID":{"like":"{{query}}"}}}'
      on-core-response="{{peopleLoaded}}"
      handleAs="json">
    </core-ajax>

     <div horizontal end-justified layout> 
      <div class="result">Found {{people_count}} documents</div>
     </div>

     <div layout vertical center>
      <template repeat="{{person in people}}">
        <person-card docid="{{person.id}}">
          <h2>{{person.CID}} {{person.FirstName}} {{person.LastName}}</h2>
        </person-card>
      </template>

      <div>
      <paper-fab id="add_button" icon="add" on-click="{{loadMore}}"></paper-fab>
      </div>
    </div>

  </template>
  
  <script>

  Polymer('person-list',{
    created: function() {
      this.p_query = this.query;
      this.people=[];
      this.page = 0;
    },
    ready: function() {
    },
    loadMore: function() {
      this.page+=10;
    },
    peopleLoaded: function() {
      var list = this.$.ajax.response;
      if(this.p_query!=this.query) {
        this.p_query = this.query;
        this.page = 0;
        this.people=[];
      }
      if(list) {
        for(var i=0;i<list.length;i++) {
          this.people.push(list[i]);
        }
        console.log(this.people.length);
        if(this.people_count == this.people.length) {
          this.$.add_button.style.display="none";
        } else {
          this.$.add_button.style.display="block";
        }
      }
    },
    countReturn: function() {
      if(this.$.people_count.response) {
        this.people_count = this.$.people_count.response.count;
      }
    }
  });
  </script>
</polymer-element>
