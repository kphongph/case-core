<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="elements/lp-query.html">
<link rel="import" href="elements/chart-controller.html">
<link rel="import" href="elements/registered-student.html">
<link rel="import" href="elements/disability-people.html">

<dom-module id="i-report">
  <style>
    :host {
      display: block;
      box-sizing: border-box;
    }
    .list paper-checkbox{
      padding-bottom: 10px;
    }
  </style>
  <template>
    <div style="width:100%;">
      <chart-controller action="{{actionString}}" cols="{{cols}}" rows="{{rows}}"></chart-controller>
    </div>
    <div>
      <paper-checkbox on-change="_checkChanged" name="education" value=4>ป.1</paper-checkbox>
      <paper-checkbox on-change="_checkChanged" name="education" value=7>ป.4</paper-checkbox>
      <paper-checkbox on-change="_checkChanged" name="education" value=10>ม.1</paper-checkbox>
      <paper-checkbox on-change="_checkChanged" name="education" value=13>ม.4</paper-checkbox>
    </div>
    <div class="list">
      <br /><paper-checkbox on-change="_checkChanged" name="graduate" value=13>อัตราเรียนต่อ ม.4</paper-checkbox>
      <br /><paper-checkbox on-change="_checkChanged" name="exist" value=13>จำนวนเด็กหลุดออกจากระบบการศึกษาภาคบังคับ</paper-checkbox>
      <br /><paper-checkbox on-change="_checkChanged" name="poor" value=13>จำนวนเด็กที่อยู่ในครอบครัวยากจน</paper-checkbox>
      <h3>การเข้าถึงสื่อคอมพิวเตอร์</h3>
      <paper-checkbox on-change="_checkChanged" name="allStudents" value=13>นักเรียนทั้งหมด</paper-checkbox><br />
      <paper-checkbox on-change="_checkChanged" name="allComputers" value=13>คอมพิวเตอร์ทั้งหมด</paper-checkbox>
    </div>
    <div>
      <lp-query 
         ds="{{ds}}"
         where="{{where}}"
         filter="{{filter}}"
         result="{{result}}">
      </lp-query>
      <span>{{result.count}}</span>
    </div>
 </template>
</dom-module>

<script>
  Polymer({
    is:'i-report',
    ready: function() {
      this.cols = [
          {label: "Topic(key)", type: "string"},
          {label: "Result(value)", type: "number"}
        ];
      this.rows = [[null, null]];
      this.ds = "/api/educationchildren/count";
      this.hostid = "3720140208";
    },
    properties: {
     actionString: {
        type: String
      },
      hostid: String,
      cols: Object,
      ds: String,
      rows: Object,
      where: Object,
      action: {
        type: Object,
        value: {
          target: {
            id: String,
            value: String,
            text: String
          },
          operation: {
            type: String
          }
        }
      },
      result: {
        type: Object,
        observer: '_resultChanged'
      }
    },
    _resultChanged: function(){
      if(this.result){
        var key = Object.keys(this.result)[0];
        if(key == 0){
          this.action.target.value = this.result[key][Object.keys(this.result[key])];
        }
        else{
          this.action.target.value = this.result[key];
        }
        this.actionString = JSON.stringify(this.action);
      }
    },
    _checkChanged: function(e) {
      var checkbox = e.target;
      this.action.target.id = checkbox.getAttribute('value');
      this.action.target.text = Polymer.dom(checkbox).textContent;
      this.action.operation = 'insert';
      if(!checkbox.checked){
        this.action.operation = 'delete';
        this.actionString = JSON.stringify(this.action);
      }
      else{
        this._query(checkbox.getAttribute('name'));
      }
    },
    _query: function(name){
      if(name == 'education'){
        this.ds = "/api/educationchildren/count";
        this.filter = null;
        this.where = {
          and:[
            {educationclassid:this.action.target.id},
            {enddate:null}
          ]
        };
      }
      else if(name == 'graduate'){
        this.ds = "/api/aftergradstudents/count";
        this.filter = null;
        this.where = {
          aftergradid:{
            inq:["01","02","03","04"]
          }
        };
      }
      else if(name == 'exist'){
        // relation
      }
      else if(name == 'poor'){
        this.ds = "/api/welfarepeople/count";
        this.filter = null;
        this.where = { welfareid :"06" };
      }
      else if(name == 'allStudents'){
        this.ds = "/api/educationchildren/count";
        this.filter = null;
        this.where = { enddate :null }
      }
      else if(name == 'allComputers'){
        this.ds = "/api/hostcomputers";
        this.where = null;
        this.filter = {
          hostid: this.hostid,
          order: 'updatetime DESC',
          limit: 1,
          fields:["studentpc"]
        };
      }
    }
  });
</script>
<i-report></i-report>
