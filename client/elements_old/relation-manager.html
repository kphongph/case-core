<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="./relation-filter.html">

<dom-module id="relation-manager">
  <style>
    .container{
      width: 450px;
      height: 450px;
      border-style: solid;
      border-width: 1px;
      border-color: #E0E0E0;
      font-family: 'Roboto Regular', sans-serif;
      background-color: #FFFFFF;
    }
    .content{
      @apply(--layout-vertical);
      padding: 5px;
      height: 300px;
      overflow-y: auto;
    }
    .add {
      width: 50px;
      position: absolute;
      top: 20%;
      right: 10px;
    }
    .remove {
      width: 50px;
      position: absolute;
      right: 0;
      color: #F44336;
      cursor: none;
    }
    paper-toolbar.header {
      --paper-toolbar-background: #4CAF50;
    }
    paper-toolbar.header .header-text {
      font-size: 150%;
    }
    paper-material{
      padding: 5px;
      height: 40px;
      @apply(--layout-horizontal);
    }
    paper-material .blue {
      width: 40px;
	    height: 40px;
	    border-radius: 20px;
	    -webkit-border-radius: 20px;
	    -moz-border-radius: 20px;
	    background-color: var(--paper-light-blue-500);
    }
    paper-material .red {
      width: 40px;
	    height: 40px;
	    border-radius: 20px;
	    -webkit-border-radius: 20px;
	    -moz-border-radius: 20px;
	    background-color: var(--paper-red-500);
    }
    paper-material .orange {
      width: 40px;
	    height: 40px;
	    border-radius: 20px;
	    -webkit-border-radius: 20px;
	    -moz-border-radius: 20px;
	    background-color: var(--paper-orange-500);
    }
    paper-material .body {
      padding: 5px 0 0 10px;
      font-size: 80%;
    }
    .relation-icon {
      text-align: center;
      margin-top: 25%;
      cursor: pointer;
    }
    .dialog-panel {
      min-width: 900px;
      min-height: 450px;
    }
  </style>
  <template>
    <div class="container" id="relationPanel">
      <paper-header-panel mode="seamed">
        <paper-toolbar class="header">
          <div class="header-text">Relationships</div>
          <div class="add">
            <paper-icon-button icon="add" on-click="_handleAddClicked"></paper-icon-button>
          </div>
        </paper-toolbar>
        <div class="content" id="panel">
          
          <template is="dom-repeat" items="{{relations}}">
            <paper-material elevation="1" id="{{index}}">
              <div class$="{{_getRelationColor(item.relation)}}">
                <p class="relation-icon" 
                  title="{{_getTitle(item.relation)}}">{{_getRelationShort(item.relation)}}
                </p>
              </div>
              <div class="body">
                <div class="first"><span>{{item.left.model}}</span>.<span>{{item.left.property}}</span></div>
                <div class="last"><span>{{item.right.model}}</span>.<span>{{item.right.property}}</span></div>
              </div>
              <div class="remove">
                <paper-icon-button icon="clear" value$="{{index}}" on-tap="_handleRemoveClicked"></paper-icon-button>
              </div>
            </paper-material>
          </template>
          
        </div>
      </paper-header-panel>
    </div>
    
    <div>
      <paper-dialog class="dialog-panel" id="dialog">
        <h2>Relationship Editor</h2>
        <div class="dialog-body">
          <relation-filter id="rFilter" models="{{models}}"></relation-filter>
        </div>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm autofocus on-click="_handleDialogConfirm">OK</paper-button>
        </div>
      </paper-dialog>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'relation-manager',
    properties: {
      relations : {
        type: Array
      },
      data: {
        type: Array,
        notify: true
      }
    },
    ready: function() {
    },
    _getRelationShort: function(text){
      if(text){
        if(text == 'join'){
          return 'J';
        }
        else if(text == 'leftJoin'){
          return 'LJ';
        }
        else if(text == 'rightJoin'){
          return 'RJ';
        }
      }
    },
    _getRelationColor: function(text){
      if(text){
        if(text == 'join'){
          return 'blue';
        }
        else if(text == 'leftJoin'){
          return 'red';
        }
        else if(text == 'rightJoin'){
          return 'orange';
        }
      }
    },
    _getTitle: function(text){
      if(text){
        var splited = text.toLowerCase().split('join');
        splited.push('join')
        splited = splited.map(function(x) { return x.toUpperCase(); });
        return splited.join(' ');
      }
    },
    _handleAddClicked: function(){
      this.$.relationPanel.parentNode.style.width = '450px';
      this.$.dialog.open();
    },
    _handleRemoveClicked: function(e){
      var list = Polymer.dom(this.$.panel).querySelectorAll('paper-material');
      var el = e.target;
      for(var i = 0; i < 5; i++){
        if(el.tagName.toLowerCase() == 'paper-icon-button'){
          break;
        }
        else{
          el = el.parentElement;
        }
      }
      var id = el.getAttribute('value');
      this.relations.splice(Number(id), 1);
      this.relations = this.relations.slice(0);
      this.cleanData();
    },
    _handleDialogConfirm: function(){
      var value = JSON.parse(JSON.stringify(this.$.rFilter.relation)); // force new object
      if(!this.relations){
        this.relations = [];
      }
      
      if(!this.contains(this.relations, value)
      && value.relation 
      && value.left.model && value.left.property
      && value.right.model && value.right.property){
        this.relations.push(value);
        this.relations = this.relations.slice();
        this.cleanData();
      }
    },
    cleanData: function(){
      if(this.relations.length > 0){
        var tmp = [];
        for(var i = 0; i < this.relations.length; i++){
          var relation = JSON.parse(JSON.stringify(this.relations[i]));
          relation.left.property = [relation.left.property];
          relation.right.property = [relation.right.property];
          for(var j = i+1; j < this.relations.length; j++){
            if(this.relations[i].left.model == this.relations[j].left.model
            && this.relations[i].right.model == this.relations[j].right.model){
              relation.left.property.push(this.relations[j].left.property);
              relation.right.property.push(this.relations[j].right.property);
            }
          }
          if(!this.containsExceptProperty(tmp, relation)){
            tmp.push(relation);
          }
        }
        this.data = tmp.slice();
      }
      else{
        this.data = [];
      }
      this.fire('select');
    },
    contains: function(array, obj){
      for(var i = 0; i < array.length; i++){
        if(array[i].relation === obj.relation
        && array[i].left.model === obj.left.model
        && array[i].left.property === obj.left.property
        && array[i].right.model === obj.right.model
        && array[i].right.property === obj.right.property){
          return true;
        }
      }
      return false;
    },
    containsExceptProperty: function(array, obj){
      for(var i = 0; i < array.length; i++){
        if(array[i].relation === obj.relation
        && array[i].left.model === obj.left.model
        && array[i].right.model === obj.right.model){
          return true;
        }
      }
      return false;
    },
    doJob: function(job){
      this.$.rFilter.relation = JSON.parse(JSON.stringify(job.value));
      this._handleDialogConfirm();
    }
  });
</script>
