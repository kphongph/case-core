<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="join-table">
  <template>
    <iron-ajax id="leftAjax" 
      handle-as="json"
      on-response="_handleLeftAjax">
    </iron-ajax>
    
    <iron-ajax id="rightAjax" 
      handle-as="json"
      on-response="_handleRightAjax">
    </iron-ajax>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'join-table',
    properties: {
      leftTable : Array,
      rightTable : Array,
      relations: Array,
      fullTable : Array,
      currentRelation: Object
    },
    ready: function(){
    },
    _test_joinFullTable: function(){
      var relation = JSON.parse(JSON.stringify(this.currentRelation));
      //change url limit=0 -> all rows
      var url = relation.left.url;
      var start = url.indexOf('limit'); 
      var  end;
      for(var i = 156; i < url.length; i++){
        if(url[i] == ':'){
            start = i+1;
        }
        if(url[i] == ',' || url[i] == '}'){
            end = i;break;
        }
      }
      console.log(start + ' : ' + end)
      url = url.substring(0, start) + '0' + url.substring(end);
      console.log(url)
    },
    join: function(relations){
      this.relations = relations;
      // test index 0
      this.currentRelation = relations[0];
      this._test_joinFullTable();
      this._leftJoin();
    },
    _leftJoin : function(data){
      this.leftTable = [];
      this.rightTable = [];
      if(this.currentRelation.left.url){
        this.$.leftAjax.url = this.currentRelation.left.url;
        this.$.leftAjax.generateRequest();
      }
    },
    _handleLeftAjax : function(){
      this.leftTable = this.$.leftAjax.lastResponse;
      var properties = this.currentRelation.left.property;
      var and = [];
      for( var i = 0; i < properties.length; i++){
        var or = [];
        var distinct = [];
        for( var j = 0; j < this.leftTable.length; j++){
          var value = this.leftTable[j][properties[i]];
          if(distinct.indexOf(value) == -1){
            distinct.push(value);
          }
        }
        for( var j = 0; j < distinct.length; j++){
          var obj = {};
          obj[this.currentRelation.right.property[i]] = distinct[j];
          or.push(obj);
        }
        and.push({'or':or});
      }
      if(this.currentRelation.right.model){
        var url = '/api/' + this.currentRelation.right.model + '?filter={"where":';
        url += encodeURI(JSON.stringify({'and':and})) + '}';
        this.$.rightAjax.url = url;
        this.$.rightAjax.generateRequest();
      }
      else{
        this.mergeTable();
      }
    },
    _handleRightAjax : function(){
      this.rightTable = this.$.rightAjax.lastResponse;
      this.mergeTable();
    },
    mergeTable : function(){
      this.fullTable = [];
      for( var i = 0; i < this.leftTable.length; i++){
        if(this.rightTable){
          var isAdd = false; // is leftTable.row added
          for( var j = 0; j < this.rightTable.length; j++){
            var isJoin = true; // is all properties value map to right
            for( var k = 0; k < this.currentRelation.left.property.length; k++){
              if(this.leftTable[i][this.currentRelation.left.property[k]] 
              != this.rightTable[j][this.currentRelation.right.property[k]]){
                isJoin = false;
                break;
              }
            }
            if(isJoin){
              isAdd = true;
              this.fullTable.push(
                this.mergeObject(this.leftTable[i], this.rightTable[j]));
            }
          }
          if(!isAdd){
            this.fullTable.push(this.mergeObject(this.leftTable[i], 
            this.cloneProperties(this.rightTable[0])));
          }
        }
        else{
          this.fullTable.push(this.leftTable[i]);
        }
      }
      this.fire('join-done', this.fullTable);
    },
    cloneProperties: function(obj){
      var tmp = {};
      for(var attrname in obj) tmp[attrname]=null;
      return tmp;
    },
    mergeObject : function(obj1, obj2){
      var obj3 = {};
      for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
      for (var attrname in obj2) { obj3['r.'+attrname] = obj2[attrname]; }
      return obj3;
    }
  });
</script>