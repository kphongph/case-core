<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="job-manager">
  <style>
    
  </style>
  <template>
    <iron-ajax id="leftAjax" 
      handle-as="json"
      on-response="_handleLeftAjax">
    </iron-ajax>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'job-manager',
    properties: {
      data : {
        type: Object,
        observer: '_dataChange'
      },
      jobs: {
        type: Array
        /* array of job
        job = {
          target: _elementTargetToDoJob
          action: _addRemoveEtc
          id: _optionTargetElementID
          value: _targetValue
        }
        */
      }
    },
    ready: function() {
    },
    _dataChange: function(){
      this._generateJobs(this.data);
    },
    _newJob: function(target, id, value){
      var job = {};
      job['target'] = target;
      job['id'] = id;
      job['value'] = value;
      return job;
    },
    _generateJobs: function(data){
      this.jobs = [];
      
      // load model
      for( var i = 0; i < data.models.length; i++){
        this.jobs.push(
          this._newJob('model-filter', null, data.models[i].model)
        );
      }
      // fields filter
      for( var i = 0; i < data.models.length; i++){
        for( var j = 0; j < data.models[i].fieldsExclude.length; j++){
          this.jobs.push(
            this._newJob(
              'ds-manager', 
              data.models[i].model,
              {
                'field': data.models[i].fieldsExclude[j]
              }
            )
          );
        }
      }
      // properties
      for( var i = 0; i < data.models.length; i++){
        var properties = data.models[i].properties;
        for( var j = 0; j < properties.length; j++){
          var key = Object.keys(properties[j])[0];
          var values = properties[j][key];
          this.jobs.push(
            this._newJob(
              'ds-manager', 
              data.models[i].model,
              {
                'property': {'key':key, 'value':null, 'skip':true}
              }
            )
          );
          for( var k = 0; k < values.length; k++){
            this.jobs.push(
              this._newJob(
                'ds-manager', 
                data.models[i].model,
                {
                  'property': {'key':key, 'value':values[k], 'skip':false}
                }
              )
            );
          }
        }
      }
      
      // relations
      for( var i = 0; i < data.relations.length; i++){
        this.jobs.push(
          this._newJob(
            'core-controller', 
            'relationManager',
            data.relations[i]
          )
        );
      }
      
      //console.log(this.jobs)
      this._doJob();
    },
    _doJob: function(){
      if(!this.jobs){
        return;
      }
      if(this.jobs.length > 0){
        var job = this.jobs[0];
        this.jobs.splice(0, 1);
        if(!job.id){
          job.id = document.getElementsByTagName(job.target)[0].getAttribute('id');
        }
        var target = document.getElementById(job.id.trim());
        if(target){
          target.doJob(job);
        }
      }
    },
    finishJob: function(){
      this._doJob();
    }
  });
</script>
