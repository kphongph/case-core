<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="date-filter">
  <style>
    .container{
      display:inline;
      width: 100%;
    }
    .row{
      padding: 10px;
      @apply(--layout-horizontal);
    }
    .dateLeft{
      font-size: 60%;
      margin: 20px -40px 0 0;
    }
    .dateRight{
      font-size: 60%;
      margin: 20px 0 0 -35px;
    }
    paper-slider{
      width: 90%;
      padding-left: 5px;
      margin-top: -5px;
    }
    paper-checkbox{
      padding-right: 5px;
    }
  </style>
  <template>
    <div class="container">
      <div class="row">
        <paper-checkbox checked={{isStart}} on-click="_handleDateEnable"></paper-checkbox>
        <span class="dateLeft">{{toDateString(start)}}</span>
        <paper-slider id="sliderStart" on-track="_handleSliderTap" pin disabled={{!isStart}} 
          min="0" max="{{diff}}" value="{{startValue}}"></paper-slider>
        <span class="dateRight">{{toDateString(end)}}</span>
      </div>
      <div class="row">
        <paper-checkbox checked={{isEnd}} on-click="_handleDateEnable"></paper-checkbox>
        <span class="dateLeft">{{toDateString(start)}}</span>
        <paper-slider id="sliderEnd" on-track="_handleSliderTap" pin disabled={{!isEnd}} 
          min="0" max="{{diff}}" value="{{endValue}}"></paper-slider>
        <span class="dateRight">{{toDateString(end)}}</span>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'date-filter',
    properties: {
      start : {
        type: Date,
        notify: true
      },
      end : {
        type: Date,
        notify: true
      },
      diff : Number,
      startValue : Number,
      endValue : Number,
      selected : {
        type: Object,
        notify: true
      }
    },
    observers: [
      'computeDiff(start,end)',
      'selectedDate(startValue,endValue)',
    ],
    ready: function() {
    },
    _handleSliderTap: function(e){
      var slider = e.target.querySelector('#sliderKnobInner');
      var time = this.start.getTime() + slider.getAttribute('value')*(60*1000*60*24);
      var dateStr = this.toPinDateString(new Date(time));
      if(dateStr){
        e.target.querySelector('#sliderKnobInner').setAttribute('value', dateStr);
      }
    },
    toPinDateString: function(dateTime){
      if(dateTime.getDate() >= 1 && dateTime.getMonth() >= 0){
        return dateTime.getDate() + '-' + (dateTime.getMonth() + 1);
      }
      return null;
    },
    toDateString: function(dateTime){
      if(dateTime.getDate() >= 1 && dateTime.getMonth() >= 0){
        return dateTime.getDate() + '-' + (dateTime.getMonth() + 1) + '-' 
        + dateTime.getFullYear();
      }
      return '- -';
    },
    computeDiff : function(start,end) {
      var diff_time = end.getTime() - start.getTime();
      this.diff = diff_time/(60*1000*60*24);
    },
    selectedDate : function(s_value,e_value) {
      var s_time = this.start.getTime() + s_value*(60*1000*60*24);
      var e_time = this.start.getTime() + e_value*(60*1000*60*24);
      this.startDate = null;
      if(this.isStart){
        this.startDate = new Date(s_time);
      }
      this.endDate = null;
      if(this.isEnd){
        this.endDate = new Date(e_time);
      }
      this.selected = {
        start:this.startDate,
        end:this.endDate
      }
      this.fire('date-change',this.selected);
    },
    _handleDateEnable: function(){
      this.selectedDate(this.startValue, this.endValue);
    },
    doJob: function(job){
      if(job){
        if(!this.isStart){
          this.isStart = true;
          this._handleDateEnable();
          var value = (new Date(job.value)).getTime() - this.start.getTime();
          this.startValue = value/(60*1000*60*24);
          this.selectedDate(this.startValue, this.endValue);
          this.$.sliderStart.fire('track');
        }
        else{
          this.isEnd = true;
          this._handleDateEnable();
          var value = (new Date(job.value)).getTime() - this.start.getTime();
          this.endValue = value/(60*1000*60*24);
          this.selectedDate(this.startValue, this.endValue);
          this.$.sliderEnd.fire('track');
        }
      }
    }
  });
</script>
