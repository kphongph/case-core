<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/ctable-element/ctable-element.html">
<link rel="import" href="./model-config.html">
<link rel="import" href="./model-filter.html">

<script src="./js/requestor.js"></script>
<script src="./js/join.js"></script>

<dom-module id="core-controller">
  <style>
    .container{
      @apply(--layout-fullbleed-vertical);
      font-family: 'Roboto Regular', sans-serif;
      height: 100%;
      background-color:#FFFFFF;
    }
    .add {
      width: 50px;
      position: absolute;
      top: 20%;
      right: 10px;
    }
    .content{
      padding: 10px;
      height: 500px;
      overflow-y: scroll;
    }
    .ichart{
      width:100%;
    }
    #paperDrawerPanel [main] {

    }
    #paperDrawerPanel [drawer] {
      background-color: var(--google-grey-100);
      height: 100%;
    }
    .model-config{
      font-family: 'Roboto Regular', sans-serif;
      height: 100%;
      background-color: var(--google-grey-100);
    }
    .header-text {
      --paper-toolbar-background: #4CAF50;
      font-size: 150%;
    }
    .model-content{
      width: 100%;
      height: 100%;
      @apply(--layout-vertical);
      overflow-y: auto;
    }
  </style>
  <template>
    <model-filter id="modelFilter" 
      on-confirm="_handleModelsConfirm"
      url="/explorer/resources">
    </model-filter>
      
    <div class="container">
      <paper-drawer-panel id="paperDrawerPanel" right-drawer>
        
        <div drawer>
          <div class="model-config">
            <paper-header-panel mode="seamed">
              <paper-toolbar class="header-text">
                <div>Model configuration</div>
              </paper-toolbar>
              <div id="model-content">
                  <template is="dom-repeat" items="{{models}}">
                    <model-config 
                      on-click="_handleModelClick"
                      current-models="{{_itemToArray(item)}}" 
                      other-models="{{selectedModels}}"
                      on-new-model="_handleModelAdd"></model-config>
                  </template>
              </div>
            </paper-header-panel>
          </div>
    
        </div>
        
        <div main>
          <paper-header-panel mode="seamed">
            <paper-toolbar>
              <paper-button on-click="_handleModelButton">Model</paper-button>
              <paper-button on-click="_handleSaveButton">Save</paper-button>
              <paper-button on-click="_handleLoadButton">Load</paper-button>
              <div class="add">
                <paper-icon-button
                  id="toggleDrawer"
                  icon="chevron-right" 
                  on-click="_handleToggleDrawer"></paper-icon-button>
              </div>
            </paper-toolbar>
            
            <div>
              <ctable-element data="{{result}}" 
                 selected="{{list}}"
                 columns="{{columns}}">
              </ctable-element>
            </div>
            
          </paper-header-panel>
        </div>
        
        </paper-drawer-panel>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'core-controller',
    properties: {
      result: {
        type: Array,
        value: [
          {'CID':12345566,'Name':'P. Kijsanayothin','Sign':'#','Age':'20'}, 
          {'CID':12345567,'Name':'S. Kijsanayothin','Sign':'@','Age':'21'}, 
          {'CID':12345560,'Name':'A. Kijsanayothin','Sign':'!','Age':'22'}
        ]
      },
      columns:{
        type: Array,
        value: [  // property : label
          {'label':'cid #1','property':'CID','type':'string'}, 
          {'label':'name #2','property':'Name','type':'string'},
          {'label':'sign #3','property':'Sign','type':'string'},
          {'label':'age #4','property':'Age','type':'number'}
        ]
      },
      urls : {
          type: Array
      },
      showRPanel: {
          type : Boolean
      },
      records : {
          type: String
      },
      currentModel: String,
      models: {
        type: Array,
        observer: '_modelChange'
      },
      selectedModels: {
        type: Array
      }
    },
    ready: function() {
      this.isFieldsExist = false;
      this.$.paperDrawerPanel.drawerWidth = "500px";
    },
    _handleToggleDrawer: function(){
      if(this.$.paperDrawerPanel.hasAttribute('force-narrow')){ // hide
        this.$.paperDrawerPanel.removeAttribute('force-narrow');
        this.$.toggleDrawer.icon = 'chevron-right';
      }
      else{
        this.$.paperDrawerPanel.setAttribute('force-narrow',''); // show
        this.$.toggleDrawer.icon = 'chevron-left'
      }
    },
    _handleModelButton: function(){
      this.$.modelFilter.show();
    },
    _handleModelsConfirm: function(e){
      this.selectedModels = [];
      var tmp = [];
      if(this.models){
        for(var i = 0; i < this.models.length; i++){
          if(typeof(this.models[i]) != 'string'){
            tmp.push(this.models[i]);
          }
        }
      }
      this.models = [];
      this.models = tmp.slice();
      for(var i = 0; i < e.detail.length; i++){
        var item = e.detail[i].split('/').pop();
        this.models.push(item);
        this.selectedModels.push(item);
      }
      this.selectedModels = this.selectedModels.slice();
      this.models = this.models.slice();
    },
    _itemToArray: function(item){
      if(typeof(item) == 'string'){
        var array = [];
        array.push(item);
        return array;
      }
      else{
        return item.slice();
      }
    },
    _handleModelAdd: function(e){
      var newModels = e.detail;
      this.models.push(newModels);
      this.models = this.models.slice();
    },
    _sort: function(a, b) {
      var _a = a;
      var _b = b;
      if(typeof(a) != 'string' && a){
        _a = a.join();
      }
      if(typeof(b) != 'string' && b){
        _b = b.join();
      }
      if(_a == _b){
        return 0;
      }
      return _a < _b ? -1 : 1;
    },
    _findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{
          element = element.parentNode;
        }
      }
      return null;
    },
    _modelChange: function(){
      this.models.sort(this._sort);
    },
    _handleModelClick: function(e){
      var target = this._findUntil(e.target, 'model-config', 5);
      if(target){
        var models = target.currentModels;
        var arrayModel = [];
        for(var i = 0; i < models.length; i++){
          var obj = {};
          obj['modelName'] = models[i];
          obj['query'] = {};
          arrayModel.push(obj);
        }
        console.log(arrayModel)
        js_joinExample(this, arrayModel, this._joinExampleCallback);
      }
    },
    _getColumn: function(obj){
      var keys = Object.keys(obj);
      var array = [];
      for(var i = 0; i < keys.length; i++){
        var tmp = {'label': keys[i],'property': keys[i],'type': typeof(keys[i])};
        array.push(tmp);
      }
      return array;
    },
    _getValue: function(column, data){
      var array = [];
      for(var i = 0; i < data.length; i++){
        var tmp = {};
        for(var j = 0; j < column.length; j++){
            tmp[column[j].property] = data[i][column[j].property];
        }
        array.push(tmp);
      }
      return array;
    },
    _joinExampleCallback: function(ref, result){
      if(result){
        if(result.length > 0){
          var response = JSON.parse(result);
          ref.columns = ref._getColumn(response[0]);
          ref.result = ref._getValue(ref.columns, response);
        }
      }
    }
  });
</script>
