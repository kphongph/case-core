<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="./ds-manager.html">
<link rel="import" href="./relation-manager.html">
<link rel="import" href="./chart-core.html">
<link rel="import" href="./model-filter.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="core-controller">
  <style>
    .container{
      @apply(--layout-fullbleed-vertical);
      font-family: 'Roboto Regular', sans-serif;
      height: 600px;
      background-color:#FFFFFF;
    }
    .add {
      width: 50px;
      position: absolute;
      top: 20%;
      right: 10px;
    }
    .content{
      margin: 0 0 0 15px;
      overflow-y: auto;
    }
    paper-toolbar.header {
      --paper-toolbar-background: #E0F7FA;
    }
    paper-toolbar.header .header-text {
      font-size: 150%;
      padding: 0 30px 0 10px;
    }
    paper-tabs {
      background-color: #00bcd4;
      color: #fff;
      box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
    }
    .view{
      @apply(--layout-horizontal);
      overflow-x: auto;
    }
    .ichart{
      width:60%;
    }
    .relation{
      width:25%;
    }
  </style>
  <template>
    <iron-ajax id="leftAjax" 
      handle-as="json"
      on-response="_handleLeftAjax">
    </iron-ajax>
    
     <iron-ajax id="rightAjax" 
      handle-as="json"
      on-response="_handleRightAjax">
    </iron-ajax>
    
    <div class="container">
      <paper-header-panel mode="seamed">
        <paper-toolbar class="medium-tall">
          <paper-button on-click="_handleModelButton">Model</paper-button>
          <paper-button on-click="_handleSaveButton">Save</paper-button>
          <paper-button>Load</paper-button>
          <div class="add">
            <paper-icon-button icon="more-vert"></paper-icon-button>
          </div>
          <paper-tabs selected="0" on-tap="_handleTabSelect" id="tabs"
          class="bottom self-end" scrollable style="width: 100%;">

          <template is="dom-repeat" items="{{urls}}">
            <paper-tab>{{_getModelName(item)}}</paper-tab>
          </template>

          </paper-tabs>
        </paper-toolbar>
        <div class="content" id="contents">
          <template is="dom-repeat" items="{{urls}}" style="height:500px">
            <div node$="{{_getModelName(item)}}" hidden="{{_handleHidden(index)}}">
              <ds-manager on-done="_handleDsDone" id="{{_getModelName(item)}}" url="{{item}}"></ds-manager>
            </div>
          </template>
        </div>
        <br><hr><br>
        <div class="view">
          <div class="ichart">
            <chart-core id="iChart"></chart-core>
          </div>
          <div class="relation">
            <relation-manager id="relationManger" on-select="_handleRelationChange" models="{{models}}"></relation-manager>
          </div>
        </div>
          
      </paper-header-panel>
    </div>
    
    <div>
      <model-filter show="{{showModel}}" on-confirm="_handleDialogModelsConfirm" url="/explorer/resources"></model-filter>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'core-controller',
    properties: {
      urls : {
        type: Array
      },
      models : {
        type: Array,
        computed: '_getModels(urls)'
      },
      showRPanel: {
        type : Boolean
      },
      relation : Object,
      leftTable : Array,
      rightTable : Array,
      fullTable : Array,
      currentModel: String,
      showModel: Boolean
    },
    ready: function() {
      this.isFieldsExist = false;
      this.urls = [
        "/explorer/resources/educationchildren",
        "/explorer/resources/DropOutStudents"
      ];
    },
    _handleModelButton: function(){
      this.showModel = true;
    },
    _handleDialogModelsConfirm: function(e){
      this.showModel = false;
      this.urls = e.detail.slice(0);
    },
    _handleHidden: function(index){
      if(index == 0){
        return false;
      }
      return true;
    },
    _handleTabSelect: function(e){
      var id = e.target.innerText;
      this.currentModel = id;
      var models = Polymer.dom(this.$.contents).querySelectorAll('div');
      for(var i = 0; i < models.length; i++){
       if(models[i].getAttribute('node') == id){
        models[i].hidden = false;
       }
       else{
        models[i].hidden = true;
       }
      }
      this._checkRelation();
    },
    _handleDsDone: function(e){
      this.getFields(e);
      this.currentModel = null;
      this._checkRelation();
    },
    getFields: function(e){
      var id = e.target.id;
      for(var i = 0; i < this.models.length; i++){
        if(this.models[i].name == id && !this.models[i]['fields']){
          this.models[i]['fields'] = e.target.fields;
        }
      }
    },
    _getModelName: function(url){
      return url.split('/').pop();
    },
    _getModels: function(urls){
      var tmp = [];
      for(var i = 0; i < urls.length; i++){
        tmp.push({'name':this._getModelName(urls[i])});
      }
      return tmp;
    },
    _handleFields: function(e){
      if(!this.modelProperties){
        this.modelProperties = [];
      }
      this.modelProperties.push(e.detail);
    },
    _handleRelationChange : function(){
      this._checkRelation();
    },
    _checkRelation: function(){
      var rData = this.$.relationManger.data;
      if(rData){
        if(rData.length > 0){
          this._doJoin(rData);
        }
        else{ // no relation
          this._noRelation();
        }
      }
      else{ // no relation
        this._noRelation();
      }
    },
    _noRelation: function(){
      if(!this.currentModel){
        var index = this.$.tabs.selected;
        this.currentModel = (Polymer.dom(this.$.tabs)
        .querySelectorAll('paper-tab')[index]).innerText.trim();
      }
      if(this.currentModel){
        this.relation = {
          "relation":null,
          "left":{"model":this.currentModel,"property":[]},
          "right":{"model":null,"property":[]}
        };
        this._leftJoin();
      }
    },
    _doJoin: function(relations){
      // test at index 0
      if(relations[0].relation == 'leftJoin'){
        this.relation = relations[0];
        this._leftJoin();
      }
    },
    _leftJoin : function(data){
      this.leftTable = [];
      this.rightTable = [];
      var ds = document.getElementById(this.relation.left.model);
      if(ds){
        this.$.leftAjax.url = ds.exampleResultUrl;
        this.$.leftAjax.generateRequest();
      }
    },
    _handleLeftAjax : function(){
      this.leftTable = this.$.leftAjax.lastResponse;
      var properties = this.relation.left.property;
      var and = [];
      for( var i = 0; i < properties.length; i++){
        var or = [];
        var distinct = [];
        for( var j = 0; j < this.leftTable.length; j++){
          var value = this.leftTable[j][properties[i]];
          if(distinct.indexOf(value) == -1){
            distinct.push(value);
          }
        }
        for( var j = 0; j < distinct.length; j++){
          var obj = {};
          obj[this.relation.right.property[i]] = distinct[j];
          or.push(obj);
        }
        and.push({'or':or});
      }
      if(this.relation.right.model){
        var url = '/api/' + this.relation.right.model + '?filter={"where":';
        url += encodeURI(JSON.stringify({'and':and})) + '}';
        this.$.rightAjax.url = url;
        this.$.rightAjax.generateRequest();
      }
      else{
        this.mergeTable();
      }
    },
    _handleRightAjax : function(){
      this.rightTable = this.$.rightAjax.lastResponse;
      this.mergeTable();
    },
    mergeTable : function(){
      this.fullTable = [];
      for( var i = 0; i < this.leftTable.length; i++){
        if(this.rightTable){
          var isAdd = false; // is leftTable.row added
          for( var j = 0; j < this.rightTable.length; j++){
            var isJoin = true; // is all properties value map to right
            for( var k = 0; k < this.relation.left.property.length; k++){
              if(this.leftTable[i][this.relation.left.property[k]] 
              != this.rightTable[j][this.relation.right.property[k]]){
                isJoin = false;
                break;
              }
            }
            if(isJoin){
              isAdd = true;
              this.fullTable.push(
                this.mergeObject(this.leftTable[i], this.rightTable[j]));
            }
          }
          if(!isAdd){
            this.fullTable.push(this.mergeObject(this.leftTable[i], 
            this.cloneProperties(this.rightTable[0])));
          }
        }
        else{
          this.fullTable.push(this.leftTable[i]);
        }
      }
      this.$.iChart.dataArray = this.fullTable;
    },
    cloneProperties: function(obj){
      var tmp = {};
      for(var attrname in obj) tmp[attrname]=null;
      return tmp;
    },
    mergeObject : function(obj1, obj2){
      var obj3 = {};
      for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
      for (var attrname in obj2) { obj3['r.'+attrname] = obj2[attrname]; }
      return obj3;
    },
    _handleSaveButton: function(){
      var userData = [];
      for( var i = 0; i < this.models.length; i++){
        var model = this.models[i].name;
        var json = document.getElementById(model).json;
        var obj = {
          'model': model,
          'fields': json.fields,
          'properties': json.properties
        };
        userData.push(obj);
      }
      console.log(JSON.stringify(userData));
      // save to server...
    }
  });
</script>
