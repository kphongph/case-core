<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/ctable-element/ctable-element.html">
<link rel="import" href="./model-config.html">
<link rel="import" href="./model-filter.html">
<link rel="import" href="./result-controller.html">

<script src="../bower_components/async/lib/async.js"></script>
<script src="./js/requestor.js"></script>
<script src="./js/join.js"></script>

<dom-module id="core-controller">
  <style>
    .container{
      @apply(--layout-fullbleed-vertical);
      font-family: 'Roboto Regular', sans-serif;
      height: 100%;
      background-color:#FFFFFF;
    }
    .add {
      width: 50px;
      position: absolute;
      top: 20%;
      right: 10px;
    }
    .content{
      padding: 10px;
      height: 500px;
      overflow-y: scroll;
    }
    .ichart{
      width:100%;
    }
    #paperDrawerPanel [main] {

    }
    #paperDrawerPanel [drawer] {
      background-color: var(--google-grey-100);
      height: 100%;
    }
    .model-config{
      font-family: 'Roboto Regular', sans-serif;
      height: 100%;
      background-color: var(--google-grey-100);
    }
    .header-text {
      --paper-toolbar-background: #4CAF50;
      font-size: 150%;
    }
    .result-panel{
      width:100%;
      overflow:auto
    }
  </style>
  <template>
    <model-filter id="modelFilter" 
      on-confirm="_handleModelsConfirm"
      url="/explorer/resources">
    </model-filter>
    
    <result-controller id="runResult" max-value="{{countRecord}}" progress="{{resultProgress}}" on-run="_handleGenerateResult"></result-controller>
      
    <div class="container">
      <paper-drawer-panel id="paperDrawerPanel" right-drawer>
        
        <div drawer>
          <div class="model-config">
            <paper-header-panel mode="seamed">
              <paper-toolbar class="header-text">
                <div>Model configuration</div>
              </paper-toolbar>
              <div id="modelContent">
                  <template is="dom-repeat" items="{{models}}">
                    <model-config 
                      on-click="_handleModelClick"
                      current-models="{{_itemToArray(item)}}" 
                      other-models="{{selectedModels}}"
                      on-new-model="_handleModelAdd"></model-config>
                  </template>
              </div>
            </paper-header-panel>
          </div>
        </div>
        
        <div main>
          <paper-header-panel mode="seamed">
            <paper-toolbar>
              <paper-button on-click="_handleModelButton">Model</paper-button>
              <paper-button on-click="_handleSaveButton">Save</paper-button>
              <paper-button on-click="_handleLoadButton">Load</paper-button>
              <paper-button on-click="_handleRunButton">Run</paper-button>
              <div class="add">
                <paper-icon-button
                  id="toggleDrawer"
                  icon="chevron-right" 
                  on-click="_handleToggleDrawer"></paper-icon-button>
              </div>
            </paper-toolbar>
            
            <div class="result-panel">
              <ctable-element data="{{result}}" 
                id="ctable"
                max-row="{{maxRow}}"
                checkbox="{{showCheckbox}}"
                selected="{{list}}"
                columns="{{columns}}"
                count="{{countRecord}}"
                on-next="_handleTableNext"
                on-prev="_handleTablePrev">
              </ctable-element>
            </div>
            
          </paper-header-panel>
        </div>
        
        </paper-drawer-panel>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'core-controller',
    properties: {
      showCheckbox:{
        type: Boolean,
        value: false
      },
      maxRow: {
        type: Number,
        value: 10
      },
      currentPage: {
        type: Number,
        value: 1
      },
      countRecord: Number,
      result: Array,
      columns: Array,
      urls : Array,
      showRPanel: Boolean,
      records : String,
      currentModel: String,
      models: {
        type: Array,
        observer: '_modelChange'
      },
      selectedModels: Array,
      selectedModelConfig: Array,
      resultProgress: Number,
      genResultIndex: Number,
      recordPerRequest: {
        type: Number,
        value: 1000
      }
    },
    ready: function() {
      this.isFieldsExist = false;
      this.$.paperDrawerPanel.drawerWidth = "500px";
      //var test = [{"modelName":"DropOutStudents","query":{}},{"modelName":"EducationChildren","query":{}}];
      //js_fullWork(this, test, 91, 100, this._joinCallback);
    },
    _handleToggleDrawer: function(){
      if(this.$.paperDrawerPanel.hasAttribute('force-narrow')){ // hide
        this.$.paperDrawerPanel.removeAttribute('force-narrow');
        this.$.toggleDrawer.icon = 'chevron-right';
      }
      else{
        this.$.paperDrawerPanel.setAttribute('force-narrow',''); // show
        this.$.toggleDrawer.icon = 'chevron-left'
      }
    },
    _handleRunButton: function(){
      //if(!this.selectedModelConfig) return;
      //if(this.selectedModelConfig.length === 0) return;
      this.resultProgress = 0;
      this.$.runResult.show();
    },
    _handleModelButton: function(){
      this.$.modelFilter.show();
    },
    _handleModelsConfirm: function(e){
      this.selectedModels = [];
      var tmp = [];
      if(this.models){
        for(var i = 0; i < this.models.length; i++){
          if(typeof(this.models[i]) != 'string'){
            tmp.push(this.models[i]);
          }
        }
      }
      this.models = [];
      this.models = tmp.slice();
      for(var i = 0; i < e.detail.length; i++){
        var item = e.detail[i].split('/').pop();
        this.models.push(item);
        this.selectedModels.push(item);
      }
      this.selectedModels = this.selectedModels.slice();
      this.models = this.models.slice();
    },
    _itemToArray: function(item){
      if(typeof(item) == 'string'){
        var array = [];
        array.push(item);
        return array;
      }
      else{
        return item.slice();
      }
    },
    _handleModelAdd: function(e){
      var newModels = e.detail;
      this.models.push(newModels);
      this.models = this.models.slice();
    },
    _sort: function(a, b) {
      var _a = a;
      var _b = b;
      if(typeof(a) != 'string' && a){
        _a = a.join();
      }
      if(typeof(b) != 'string' && b){
        _b = b.join();
      }
      if(_a == _b){
        return 0;
      }
      return _a < _b ? -1 : 1;
    },
    _findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{
          element = element.parentNode;
        }
      }
      return null;
    },
    _modelChange: function(){
      this.models.sort(this._sort);
    },
    _handleModelClick: function(e){
      this.maxRow = 10;
      var target = this._findUntil(e.target, 'model-config', 5);
      if(target){
        this.currentPage = 1;
        var allModel = this.$.modelContent.querySelectorAll('model-config');
        for(var i = 0; i< allModel.length; i++){
          allModel[i].setSelected(false);
        }
        target.setSelected(true);
        var models = target.currentModels;
        this.selectedModelConfig = [];
        for(var i = 0; i < models.length; i++){
          var obj = {};
          obj['modelName'] = models[i];
          obj['query'] = {};
          this.selectedModelConfig.push(obj);
        }
        this.$.ctable.setStartPage();
        js_fullWork(this, this.selectedModelConfig, ((this.currentPage-1)*this.maxRow)+1, this.currentPage*this.maxRow, this._joinCallback);
      }
    },
    _getColumn: function(obj){
      if(!obj) return [];
      var keys = Object.keys(obj);
      var array = [];
      for(var i = 0; i < keys.length; i++){
        var tmp = {'label': keys[i],'property': keys[i],'type': typeof(keys[i])};
        array.push(tmp);
      }
      return array;
    },
    _getValue: function(column, data){
      var array = [];
      for(var i = 0; i < data.length; i++){
        var tmp = {};
        for(var j = 0; j < column.length; j++){
            tmp[column[j].property] = data[i][column[j].property];
        }
        array.push(tmp);
      }
      return array;
    },
    _joinCallback: function(ref, result, countRecord){
      ref.countRecord = countRecord;
      if(result){
        var response = [];
        if(typeof(result) == 'string'){
          response = JSON.parse(result);
        }
        else{
          response = result;
        }
        ref.columns = ref._getColumn(response[0]);
        ref.result = ref._getValue(ref.columns, response);
      }
    },
    _handleTableNext: function(){
      this.currentPage++;
      var endIndex = this.currentPage*this.maxRow;
      if(endIndex > this.countRecord) endIndex=this.countRecord;
      js_fullWork(this, this.selectedModelConfig, ((this.currentPage-1)*this.maxRow)+1, endIndex, this._joinCallback);
    },
    _handleTablePrev: function(){
      this.currentPage--;
      if(this.currentPage >= 1){
        js_fullWork(this, this.selectedModelConfig, ((this.currentPage-1)*this.maxRow)+1, this.currentPage*this.maxRow, this._joinCallback);
      }
    },
    _handleGenerateResult: function(e){
      var result = e.detail;
      this.resultProgress = 0;
      this.currentPage = 1;
      this.genResultIndex = result;
      if(this.genResultIndex.start === 0) this.genResultIndex.start = 1;
      var length = (result.end - result.start) + 1;
      if(length <= this.recordPerRequest){
        js_fullWork(this, this.selectedModelConfig, this.genResultIndex.start, result.end, this._runOneCallback);
      }
      else{
        js_fullWork(this, this.selectedModelConfig, this.genResultIndex.start, (this.genResultIndex.start+this.recordPerRequest)-1, this._runMultiCallback);
      }
    },
    _runOneCallback: function(ref, result, countRecord){
      ref.resultProgress = 100;
      if(result.length > 0){
        // do with result
      }
    },
    _runMultiCallback: function(ref, result, countRecord){
      if(result.length > 0){
        // do with result
        console.log(ref.genResultIndex, result);
      }
      
      if(ref.genResultIndex.start < ref.genResultIndex.end){
        ref.genResultIndex.start += ref.recordPerRequest;
        ref.resultProgress = ((ref.genResultIndex.start*100)/ref.genResultIndex.end).toFixed(2);
        var endIndex = (ref.genResultIndex.start+ref.recordPerRequest)-1;
        if(endIndex > ref.genResultIndex.end) endIndex=ref.genResultIndex.end;
        setTimeout(function(){
          js_fullWork(ref, ref.selectedModelConfig, ref.genResultIndex.start, endIndex, ref._runMultiCallback);
        }, 500);
        
      }
    }
  });
</script>
