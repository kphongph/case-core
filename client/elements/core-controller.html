<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="./ds-manager.html">
<link rel="import" href="./relation-manager.html">
<link rel="import" href="./chart-core.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="core-controller">
  <style>
    .container{
      display:inline;
    }
    .ichart{
      width:80%;
      padding: 20px;
      overflow:hidden;
    }
  </style>
  <template>
    <iron-ajax id="leftAjax" 
      handle-as="json"
      on-response="_handleLeftAjax">
    </iron-ajax>
    
     <iron-ajax id="rightAjax" 
      handle-as="json"
      on-response="_handleRightAjax">
    </iron-ajax>
    
    <div class="container">
      <template is="dom-repeat" items="{{urls}}">
        <ds-manager on-done="_handleDsDone" id="{{_getModelName(item)}}" url="{{item}}"></ds-manager><br /><hr />
      </template>
    </div>
    
    <relation-manager on-select="_handleRelationChange" models="{{models}}"></relation-manager>
    
    <div class="ichart">
      <chart-core id="iChart"></chart-core>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'core-controller',
    properties: {
      urls : {
        type: Array
      },
      models : {
        type: Array,
        computed: '_getModels(urls)'
      },
      showRPanel: {
        type : Boolean
      },
      relation : Object,
      leftTable : Array,
      rightTable : Array,
      fullTable : Array
    },
    _handleDsDone: function(e){
      var id = e.target.id;
      for(var i = 0; i < this.models.length; i++){
        if(this.models[i].name == id){
          this.models[i]['fields'] = e.target.fields;
        }
      }
    },
    ready: function() {
      this.showRPanel = false;
      this.urls = [
        "/explorer/resources/DropOutStudents",
        "/explorer/resources/educationchildren"
      ];
    },
    _getModelName: function(url){
      return url.split('/').pop();
    },
    _getModels: function(urls){
      var tmp = [];
      for(var i = 0; i < urls.length; i++){
        tmp.push({'name':this._getModelName(urls[i])});
      }
      return tmp;
    },
    _handleFields: function(e){
      if(!this.modelProperties){
        this.modelProperties = [];
      }
      this.modelProperties.push(e.detail);
    },
    _handleRelationChange : function(e){
      var relations = e.detail;
      //console.log(relations);
      // test at index 0
      if(relations[0].relation == 'leftJoin'){
        this.relation = relations[0];
        this._leftJoin(relations[0]);
      }
    },
    _leftJoin : function(data){
      var url = document.getElementById(data.left.model).exampleResultUrl;
      this.$.leftAjax.url = url;
      this.$.leftAjax.generateRequest();
    },
    _handleLeftAjax : function(){
      this.leftTable = this.$.leftAjax.lastResponse;
      var properties = this.relation.left.property;
      var and = [];
      for( var i = 0; i < properties.length; i++){
        var or = [];
        var distinct = [];
        for( var j = 0; j < this.leftTable.length; j++){
          var value = this.leftTable[j][properties[i]];
          if(distinct.indexOf(value) == -1){
            distinct.push(value);
          }
        }
        for( var j = 0; j < distinct.length; j++){
          var obj = {};
          obj[this.relation.right.property[i]] = distinct[j];
          or.push(obj);
        }
        and.push({'or':or});
      }
      var url = '/api/' + this.relation.right.model + '?filter={"where":';
      url += encodeURI(JSON.stringify({'and':and})) + '}';
      this.$.rightAjax.url = url;
      this.$.rightAjax.generateRequest();
    },
    _handleRightAjax : function(){
      this.rightTable = this.$.rightAjax.lastResponse;
      this.mergeTable();
    },
    mergeTable : function(){
      if(this.leftTable && this.rightTable){
        this.fullTable = [];
      }
      else{
        return;
      }
      for( var i = 0; i < this.leftTable.length; i++){
        if(this.rightTable.length > 0){
          var isAdd = false; // is leftTable.row added
          for( var j = 0; j < this.rightTable.length; j++){
            var isJoin = true; // is all properties value map to right
            for( var k = 0; k < this.relation.left.property.length; k++){
              if(this.leftTable[i][this.relation.left.property[k]] 
              != this.rightTable[j][this.relation.right.property[k]]){
                isJoin = false;
                break;
              }
            }
            if(isJoin){
              isAdd = true;
              this.fullTable.push(
                this.mergeObject(this.leftTable[i], this.rightTable[j]));
            }
          }
          if(!isAdd){
            this.fullTable.push(this.mergeObject(this.leftTable[i], 
            this.cloneProperties(this.rightTable[0])));
          }
        }
        else{
          this.fullTable.push(this.leftTable[i]);
        }
      }
      this.$.iChart.dataArray = this.fullTable;
    },
    cloneProperties: function(obj){
      var tmp = {};
      for(var attrname in obj) tmp[attrname]=null;
      return tmp;
    },
    mergeObject : function(obj1, obj2){
      var obj3 = {};
      for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
      for (var attrname in obj2) { obj3['r.'+attrname] = obj2[attrname]; }
      return obj3;
    }
  });
</script>
