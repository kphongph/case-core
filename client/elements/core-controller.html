<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/ctable-element/ctable-element.html">
<link rel="import" href="./model-config.html">
<link rel="import" href="./model-filter.html">
<link rel="import" href="./result-controller.html">

<script src="../bower_components/async/lib/async.js"></script>
<script src="./js/requestor.js"></script>
<script src="./js/join.js"></script>

<dom-module id="core-controller">
  <style>
    .container{
      @apply(--layout-fullbleed-vertical);
      font-family: 'Roboto Regular', sans-serif;
      height: 100%;
      background-color:#FFFFFF;
    }
    .add {
      width: 50px;
      position: absolute;
      top: 20%;
      right: 10px;
    }
    .content{
      padding: 10px;
      height: 500px;
      overflow-y: scroll;
    }
    .ichart{
      width:100%;
    }
    #paperDrawerPanel [main] {

    }
    #paperDrawerPanel [drawer] {
      background-color: var(--google-grey-100);
      height: 100%;
    }
    .model-config{
      font-family: 'Roboto Regular', sans-serif;
      height: 100%;
      background-color: var(--google-grey-100);
    }
    .header-text {
      --paper-toolbar-background: #4CAF50;
      font-size: 150%;
    }
    .result-panel{
      width:100%;
      overflow:auto
    }
  </style>
  <template>
    <model-filter id="modelFilter" 
      on-confirm="_handleModelsConfirm"
      url="/explorer/resources">
    </model-filter>
    
    <result-controller id="runResult" max-value="{{countRecord}}" progress="{{resultProgress}}" on-run="_handleGenerateResult"></result-controller>
      
    <paper-dialog id="sortDialog">
      <h2>Sort<span>{{sortStatus}}</span></h2>
      <paper-dialog-scrollable>
        Sort <b>{{sortValue.value}}</b> by <b>{{sortValue.text}}</b>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-click="_handleSortConfirm">OK</paper-button>
      </div>
    </paper-dialog>

    <div class="container">
      <paper-drawer-panel id="paperDrawerPanel" right-drawer>
        
        <div drawer>
          <div class="model-config">
            <paper-header-panel mode="seamed">
              <paper-toolbar class="header-text">
                <div>Model configuration</div>
              </paper-toolbar>
              <div id="modelContent">
                  <template is="dom-repeat" items="{{models}}">
                    <model-config 
                      on-click="_handleModelClick"
                      current-models="{{_itemToArray(item)}}" 
                      other-models="{{selectedModels}}"
                      on-new-model="_handleModelAdd"></model-config>
                  </template>
              </div>
            </paper-header-panel>
          </div>
        </div>
        
        <div main>
          <paper-header-panel mode="seamed">
            <paper-toolbar>
              <paper-button on-click="_handleModelButton">Model</paper-button>
              <paper-button on-click="_handleSaveButton">Save</paper-button>
              <paper-button on-click="_handleLoadButton">Load</paper-button>
              <paper-button on-click="_handleRunButton">Run</paper-button>
              <div class="add">
                <paper-icon-button
                  id="toggleDrawer"
                  icon="chevron-right" 
                  on-click="_handleToggleDrawer"></paper-icon-button>
              </div>
            </paper-toolbar>
            
            <div class="result-panel">
              <ctable-element data="{{result}}" 
                id="ctable"
                max-row="{{maxRow}}"
                checkbox="{{showCheckbox}}"
                selected="{{list}}"
                columns="{{columns}}"
                count="{{countRecord}}"
                on-next="_handleTableNext"
                on-prev="_handleTablePrev"
                on-sort="_handleSortByColumn">
              </ctable-element>
            </div>
            
          </paper-header-panel>
        </div>
        
        </paper-drawer-panel>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'core-controller',
    properties: {
      showCheckbox:{
        type: Boolean,
        value: false
      },
      maxRow: {
        type: Number,
        value: 10
      },
      currentPage: {
        type: Number,
        value: 1
      },
      countRecord: Number,
      result: Array,
      columns: Array,
      urls : Array,
      showRPanel: Boolean,
      records : String,
      currentModel: String,
      models: {
        type: Array,
        observer: '_modelChange'
      },
      selectedModels: Array,
      selectedModelConfig: Array,
      selectedModelAttr: Array,
      resultProgress: Number,
      genResultIndex: Number,
      recordPerRequest: {
        type: Number,
        value: 10000
      },
      sortValue: Object,
      oldSortValue: Object,
      sortStartIndex: Number,
      sortStartIndexTmp: Number,
      distinctValueIndex: Number,
      distinctValueIndexTmp: Number,
      distinctValueIndexArray: Array,
      distinctValue: Array,
      sortStatus: String,
      startTime: Date,
      endTime: Date
    },
    ready: function() {
      this.isFieldsExist = false;
      this.$.paperDrawerPanel.drawerWidth = "500px";
      //var test = [{"modelName":"DropOutStudents","query":{}},{"modelName":"EducationChildren","query":{}}];
      //js_fullWork(this, test, 91, 100, this._joinCallback);
    },
    _handleToggleDrawer: function(){
      if(this.$.paperDrawerPanel.hasAttribute('force-narrow')){ // hide
        this.$.paperDrawerPanel.removeAttribute('force-narrow');
        this.$.toggleDrawer.icon = 'chevron-right';
      }
      else{
        this.$.paperDrawerPanel.setAttribute('force-narrow',''); // show
        this.$.toggleDrawer.icon = 'chevron-left'
      }
    },
    _handleRunButton: function(){
      if(!this.selectedModelConfig) return;
      if(this.selectedModelConfig.length === 0) return;
      this.resultProgress = 0;
      this.$.runResult.show();
    },
    _handleModelButton: function(){
      this.$.modelFilter.show();
    },
    _handleModelsConfirm: function(e){
      this.selectedModels = [];
      this.selectedModelAttr = e.detail;
      var tmp = [];
      if(this.models){
        for(var i = 0; i < this.models.length; i++){
          if(typeof(this.models[i]) != 'string'){
            tmp.push(this.models[i]);
          }
        }
      }
      this.models = [];
      this.models = tmp.slice();
      for(var i = 0; i < e.detail.length; i++){
        var item = e.detail[i].model;
        this.models.push(item);
        this.selectedModels.push(item);
      }
      this.selectedModels = this.selectedModels.slice();
      this.models = this.models.slice();
    },
    _itemToArray: function(item){
      if(typeof(item) == 'string'){
        var array = [];
        array.push(item);
        return array;
      }
      else{
        return item.slice();
      }
    },
    _handleModelAdd: function(e){
      var newModels = e.detail;
      this.models.push(newModels);
      this.models = this.models.slice();
    },
    _sort: function(a, b) {
      var _a = a;
      var _b = b;
      if(typeof(a) != 'string' && a){
        _a = a.join();
      }
      if(typeof(b) != 'string' && b){
        _b = b.join();
      }
      if(_a == _b){
        return 0;
      }
      return _a < _b ? -1 : 1;
    },
    _findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{
          element = element.parentNode;
        }
      }
      return null;
    },
    _modelChange: function(){
      this.models.sort(this._sort);
    },
    _handleModelClick: function(e){
      var target = this._findUntil(e.target, 'model-config', 5);
      if(target){
        this.currentPage = 1;
        var allModel = this.$.modelContent.querySelectorAll('model-config');
        for(var i = 0; i< allModel.length; i++){
          allModel[i].setSelected(false);
        }
        target.setSelected(true);
        var models = target.currentModels;
        this.selectedModelConfig = [];
        for(var i = 0; i < models.length; i++){
          var obj = {};
          obj['modelName'] = models[i];
          obj['query'] = {};
          this.selectedModelConfig.push(obj);
        }
        this.$.ctable.setStartPage();
        this.countRecord = null;
        this.columns = [];
        this.result = [];
        this.sortValue = null;
        this.sortStartIndex = 1;
        js_fullWork(this, this.selectedModelConfig, ((this.currentPage-1)*this.maxRow)+1, this.currentPage*this.maxRow, this._joinCallback);
      }
    },
    _getColumn: function(obj){
      if(!obj) return [];
      var keys = Object.keys(obj);
      var array = [];
      for(var i = 0; i < keys.length; i++){
        var tmp = {'label': keys[i],'property': keys[i],'type': typeof(keys[i])};
        array.push(tmp);
      }
      return array;
    },
    _getValue: function(column, data){
      var array = [];
      for(var i = 0; i < data.length; i++){
        var tmp = {};
        for(var j = 0; j < column.length; j++){
            tmp[column[j].property] = data[i][column[j].property];
        }
        array.push(tmp);
      }
      return array;
    },
    _joinCallback: function(ref, result, countRecord){
      var isFirst = false; 
      if(!ref.countRecord){
        ref.countRecord = countRecord;
      }
      if(result){
        var response = [];
        if(typeof(result) == 'string'){
          response = JSON.parse(result);
        }
        else{
          response = result;
        }
        if(ref.columns.length === 0){
          ref.columns = ref._getColumn(response[0]);
        }
        if(ref.result.length === 0){
          ref.result = ref._getValue(ref.columns, response);
          isFirst = true;
        }
        else{
          // append result
          ref.result = ref.result.concat(response);
        }
        if(ref.distinctValue){
          if(ref.result.length < ref.maxRow && ref.sortStartIndex < ref.distinctValue.length){
            // get more result
            ref.sortStartIndex++;
            for(var i = 0; i < ref.selectedModelConfig.length; i++){
              if(ref.selectedModelConfig[i].modelName === ref.sortValue.model){
                var query = ref.selectedModelConfig[i].query;
                if(!query.where){
                  query['where'] = {};
                }
                if(ref.selectedModelConfig[i].countQuery <= ref.maxRow){ // call with another value
                  ref.sortStartIndex = 1;
                  ref.distinctValueIndex++;
                  query.where[ref.sortValue.value] = ref.distinctValue[ref.distinctValueIndex-1];
                  ref.selectedModelConfig[i].query = query;
                }
                else{
                  ref.sortStartIndex++;
                }
              }
            }
            js_fullWork(ref, ref.selectedModelConfig, ((ref.sortStartIndex-1)*ref.maxRow)+1, ref.sortStartIndex*ref.maxRow, ref._joinCallback);
          }
          else{
            ref.distinctValueIndexArray.push(ref.distinctValueIndex + 1);
            ref.$.sortDialog.close();
            // ending request time 
            ref.endTime = new Date();
            console.log('ending time ' + ref.endTime);
            var diff = (ref.endTime-ref.startTime)/1000;
            console.log('preview ' + diff + 's. for ' + countRecord + ' records.');
            console.log('------------------------------------------------------------.');
          }
        }
      }
    },
    _handleTableNext: function(){
      this.currentPage++;
      var endIndex = this.currentPage*this.maxRow;
      if(endIndex > this.countRecord) endIndex=this.countRecord;
      if(!this.distinctValue){
        js_fullWork(this, this.selectedModelConfig, ((this.currentPage-1)*this.maxRow)+1, endIndex, this._joinCallback);
      }
      else{
        this.sortStartIndex++;
        this.result = [];
        js_fullWork(this, this.selectedModelConfig, ((this.sortStartIndex-1)*this.maxRow)+1, this.sortStartIndex*this.maxRow, this._joinCallback);
      }
    },
    _handleTablePrev: function(){
      if(!this.distinctValue){
        this.currentPage--;
        if(this.currentPage >= 1){
          js_fullWork(this, this.selectedModelConfig, ((this.currentPage-1)*this.maxRow)+1, this.currentPage*this.maxRow, this._joinCallback);
        }
      }
      else{
        this.distinctValueIndexArray.pop();
        this.distinctValueIndexArray.pop();
        this.distinctValueIndex = this.distinctValueIndexArray.pop();
        this.sortStartIndex = 1; // skip 1 value
        this.result = [];
        for(var i = 0; i < this.selectedModelConfig.length; i++){
          if(this.selectedModelConfig[i].modelName === this.sortValue.model){
            var query = this.selectedModelConfig[i].query;
            if(!query.where){
              query['where'] = {};
            }
            delete query.where[this.oldSortValue];
            this.oldSortValue = this.sortValue.value;
            query.where[this.sortValue.value] = this.distinctValue[this.distinctValueIndex-1];
            this.selectedModelConfig[i].query = query;
          }
        }
        js_fullWork(this, this.selectedModelConfig, ((this.sortStartIndex-1)*this.maxRow)+1, this.sortStartIndex*this.maxRow, this._joinCallback);
      }
    },
    _handleGenerateResult: function(e){
      this.startTime = new Date();
      console.log('starting time ' + this.startTime);
      
      var result = e.detail;
      this.resultProgress = 0;
      this.currentPage = 1;
      this.genResultIndex = result;
      if(this.genResultIndex.start === 0) this.genResultIndex.start = 1;
      var length = (result.end - result.start) + 1;
      if(length <= this.recordPerRequest){
        js_fullWork(this, this.selectedModelConfig, this.genResultIndex.start, result.end, this._runOneCallback);
      }
      else{
        if(!this.distinctValue){
          js_fullWork(this, this.selectedModelConfig, this.genResultIndex.start, (this.genResultIndex.start+this.recordPerRequest)-1, this._runMultiCallback);
        }
        else{
          this.sortStartIndexTmp = this.sortStartIndex;
          this.sortStartIndex = 1;
          this.distinctValueIndexTmp = this.distinctValueIndex;
          this.distinctValueIndex = 1;
          js_fullWork(this, this.selectedModelConfig, 1, this.recordPerRequest, this._runMultiCallback);
        }
      }
    },
    _runOneCallback: function(ref, result, countRecord){
      ref.resultProgress = 100;
      if(result.length > 0){
        // do with result
      }
    },
    _runMultiCallback: function(ref, result, countRecord){
      if(result.length > 0){
        // do with result
        //console.log(ref.genResultIndex.start + result.length);
      }
      ref.genResultIndex.start += result.length;
      if(ref.genResultIndex.start < ref.genResultIndex.end){
        ref.resultProgress = ((ref.genResultIndex.start*100)/ref.genResultIndex.end).toFixed(2);
        var endIndex = (ref.genResultIndex.start+ref.recordPerRequest)-1;
        if(endIndex > ref.genResultIndex.end) endIndex=ref.genResultIndex.end;
        setTimeout(function(){
          if(!ref.distinctValue){
            js_fullWork(ref, ref.selectedModelConfig, ref.genResultIndex.start, endIndex, ref._runMultiCallback);
          }
          else{
            for(var i = 0; i < ref.selectedModelConfig.length; i++){
              if(ref.selectedModelConfig[i].modelName === ref.sortValue.model){
                var query = ref.selectedModelConfig[i].query;
                if(!query.where){
                  query['where'] = {};
                }
                if(ref.selectedModelConfig[i].countQuery <= ref.maxRow){ // call with another value
                  ref.sortStartIndex = 1;
                  ref.distinctValueIndex++;
                  query.where[ref.sortValue.value] = ref.distinctValue[ref.distinctValueIndex-1];
                  ref.selectedModelConfig[i].query = query;
                }
                else{
                  ref.sortStartIndex++;
                }
              }
            }
             js_fullWork(ref, ref.selectedModelConfig, ((ref.sortStartIndex-1)*ref.maxRow)+1, ref.sortStartIndex*ref.recordPerRequest, ref._runMultiCallback);
          }
        }, 500);
        
      }
      else{
        ref.resultProgress = 100;
        ref.sortStartIndex  = ref.sortStartIndexTmp;
        ref.distinctValueIndex  = ref.distinctValueIndexTmp;
        // ending request time 
        ref.endTime = new Date();
        console.log('ending time ' + ref.endTime);
        var diff = (ref.endTime-ref.startTime)/1000;
        console.log('gen result ' + diff + 's. for ' + countRecord + ' records.');
        console.log('------------------------------------------------------------.');
      }
    },
    _handleSortByColumn: function(e){
      this.sortValue = e.detail;
      this.sortStatus = '';
      this.$.sortDialog.open();
    },
    _handleSortConfirm: function(){
      this.startTime = new Date();
      console.log('starting time ' + this.startTime);
      
      this.result = [];
      this.distinctValue = [];
      var model = this._findModelByAttr(this.sortValue.value);
      var sortBy = this.sortValue.text;
      var attr = this.sortValue.value;
      
      if(!this.oldSortValue){
        this.set("oldSortValue", attr);
      }
      
      var n = attr.match(/\d+/g);
      if(n){
        attr = attr.substring(0, attr.length-n[0].length);
      }
      this.sortValue.value = attr;
      this.sortValue.model = model;
      this.sortStatus = '(processing...)';
      js_distinct(this, model, attr, sortBy, this._handleSortCallback);
      
    },
    _handleSortCallback: function(ref, result){ // result = sort and distinct
      ref.distinctValue = result;
      ref.sortStartIndex = 1;
      ref.distinctValueIndex = 1;
      if(!ref.distinctValueIndexArray) ref.distinctValueIndexArray = [];
      ref.distinctValueIndexArray.push(ref.distinctValueIndex);
      for(var i = 0; i < ref.selectedModelConfig.length; i++){
        if(ref.selectedModelConfig[i].modelName === ref.sortValue.model){
          var query = ref.selectedModelConfig[i].query;
          if(!query.where){
            query['where'] = {};
          }
          delete query.where[ref.oldSortValue];
          ref.oldSortValue = ref.sortValue.value;
          query.where[ref.sortValue.value] = result[ref.distinctValueIndex-1];
          ref.selectedModelConfig[i].query = query;
        }
      }
      js_fullWork(ref, ref.selectedModelConfig, ((ref.sortStartIndex-1)*ref.maxRow)+1, ref.sortStartIndex*ref.maxRow, ref._joinCallback);
    },
    _findModelByAttr: function(attr){
      if(!this.selectedModelConfig) return null;
      if(!this.selectedModelAttr) return null;
      var tmp = [];
      for(var i = 0; i < this.selectedModelConfig.length; i++){
        for(var j = 0; j < this.selectedModelAttr.length; j++){
          if(this.selectedModelConfig[i].modelName === this.selectedModelAttr[j].model){
            tmp.push(this.selectedModelAttr[j]);
          }
        }
      }
      var n = attr.match(/\d+/g);
      var number = 0;
      if(n){
        number = Number(n[0])
      }
      if(number > 0){
        var attrs = tmp[number].attr;
        var findString = attr.substring(0, attr.length-number.toString().length);
        for(var j = 0; j < attrs.length; j++){
          if(attrs[j] === findString){
            return tmp[number].model;
          }
        }
      }
      else{
        for(var i = 0; i < tmp.length; i++){
          var model = tmp[i].model;
          var attrs = tmp[i].attr;
          for(var j = 0; j < attrs.length; j++){
            if(attrs[j] === attr){
              return model;
            }
          }
        }
      }
    }
  });
</script>
