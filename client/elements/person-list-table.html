<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/ctable-element/ctable-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="person-list">
 <template>
  <iron-ajax id="people_count"
    auto
    last-response="{{count}}"
    handleAs="json">
  </iron-ajax>

  <iron-ajax id="ajax"
    auto
    last-response="{{people}}"
    on-last-response-changed="parseToArray"
    handleAs="json">
  </iron-ajax>

  <input type="text" value="{{query::input}}">
   
  <div horizontal end-justified layout> 
    <div id="result" value="{{count.count}}">Found 
    <span>{{count.count}}</span> documents</div>
  </div>

  <div>
    <ctable-element data="{{peopleArray}}" columns="{{columns}}"></ctable-element>
  </div>
  
  <div layout horizontal center>
    <br />
    <button on-click="previousClick">previous</button>
    <button on-click="nextClick">next</button>
  </div>
 </template>
</dom-module>


<script>
  Polymer({
    is:'person-list',
    page_index: 1,
    query_text: {
      limit:10, 
      skip: 0,
      fields:['CID','FirstName','LastName'],
      where: {
        CID:{
          like:this.query
        }
      }
    },
    properties: {
      query: {
        type: String,
        observer: '_queryValueChanged'
      },
      peopleArray: {
        type: Array,
        value: []
      },
      columns:{
        type: Array,
        value: [  // property : label
          {'label':'CID','property':'CID'}, 
          {'label':'First Name','property':'First'},
          {'label':'Last Name','property':'Last'}
        ]
      }
    },
    _createEmptyArray: function(rows) {
      var x = new Array(rows);
      for (var i = 0; i < rows; i++) {
        x[i] = new Object();
      }
      return x;
    },
    parseToArray: function(){
      if(this.people){
        this.peopleArray = this._createEmptyArray(10);
        for(var i=0; i< this.people.length; i++){
          this.peopleArray[i]['CID'] = this.people[i]['CID'];
          this.peopleArray[i]['First'] = this.people[i]['FirstName'];
          this.peopleArray[i]['Last'] = this.people[i]['LastName'];
        }
      }
    },
    _queryValueChanged: function() {
      this.query_text.where.CID.like = this.query;
      this.queryPerson();
      this.$.people_count.url = "../api/people/count?where="+
        JSON.stringify(this.query_text.where); 
      this.$.people_count.generateRequest();
    },
    queryPerson: function(){
      this.$.ajax.url="../api/people?filter="+JSON.stringify(this.query_text);
      this.$.ajax.generateRequest();
    },
    previousClick: function() {
      if(this.page_index > 1){
        this.query_text.skip -= 10;;
        this.page_index--;
        this.queryPerson();
      }
    },
    nextClick: function() {
      if(this.$.result.value > this.query_text.skip){
        this.query_text.skip += 10;;
        this.page_index++;
        this.queryPerson();
      }
    },
  });
</script>
