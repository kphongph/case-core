<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="date-filter.html">

<dom-module id="attr-filter">
  <template>
    <iron-ajax id="worker" 
      handle-as="json"
      on-response="_handleRequest">
    </iron-ajax>

    <iron-ajax id="nullWorker" 
      handle-as="json"
      on-response="_handleNullRequest">
    </iron-ajax>

    <paper-checkbox id="checkbox" on-change="_handleSelect">
      <span>{{_propertyToString(description)}}</span>
    </paper-checkbox>

    <div id="valuePanel">
      <template is="dom-if" if="{{attr.nullExist}}">
        <h4>Type: isNULL</h4>
        <p>
         &nbsp;&nbsp;&nbsp;
         <paper-checkbox on-change="_handleNullSelect">Null?</paper-checkbox>
        </p>
      </template>
         
      <template is="dom-if" if="{{attr.isCategory}}">
        <h4>Type: Category</h4>
        <template is="dom-repeat" items="{{content}}">
         <p>
         &nbsp;&nbsp;&nbsp;
         <paper-checkbox on-change="_handleCategorySelect">
          <span>{{item.name}}</span> &nbsp;
          (<span>{{item.value.count}}</span>)
         </paper-checkbox>
         </p>
        </template>
      </template>
      
      <template is="dom-if" if="{{attr.isDate}}">
        <div style="padding-left:10px">
          <date-filter 
            end="{{attr.end_date}}"
            on-date-change="_handleDateSelect"
            start="{{attr.start_date}}">
          </date-filter>
        </div>
      </template>
      
      <template is="dom-if" if="{{attr.isText}}">
        <div style="padding-left:10px">
          <paper-input label="Text to find" on-input="_handleTextChanged"></paper-input>
        </div>
      </template>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is: 'attr-filter',
    properties: {
      description : {
        type: Object,
        notify: true
      },
      model: String,
      query: {
        type: Object,
        notify:true
      },
      resource : String,
      attr : {
        type: Object,
        notify:true,
      },
      content: {
        type: Object,
        notify: true
      }
    },
    ready: function() {
    },
    _handleSelect : function(e) {
      if(!this.$.checkbox.checked) {
        var allCheckbox = this.$.valuePanel.querySelectorAll('paper-checkbox');
        for(var i=0; i<allCheckbox.length; i++){
          if(allCheckbox[i].checked){
            allCheckbox[i].checked = !allCheckbox[i].checked;
          }
        }
        if(this.query){
          this.query = null;
        }
        var obj = {
          'attr':this.description.name,
          'query':this.query,
          'model':this.model
        };
        this.fire('filter',obj);
        this.$.valuePanel.style.display = 'none';
      } else {
        this.$.valuePanel.style.display = 'block';
      }

      if(this.$.checkbox.checked && !this.content) {

        this.content = [];
        this.set('attr',{});

        // check null
        var query_null = {};
        query_null[this.description.name] = null;
        this.$.nullWorker.url = this.resource+'/count?where='+JSON.stringify(query_null);
        this.$.nullWorker.generateRequest();
        
        // query all without null
        var query = {fields:{},where:{}};
        query.fields[this.description.name] = true;
        query.where[this.description.name] = {'neq':null};
        this.$.worker.url = this.resource+'?filter='+JSON.stringify(query);
        this.$.worker.generateRequest();
      }
    },
    _handleRequest : function() {
      var response = this.$.worker.lastResponse;
      var tmp = {};
      var max_categories = 50;
      var j=0;
      for(var i=0;i<response.length&&j<max_categories;i++) {
        if(!tmp[response[i][this.description.name]]) {
          tmp[response[i][this.description.name]] = {count:0};
          j++;
        }
        tmp[response[i][this.description.name]].count++;
      }

      this.content = Object.keys(tmp).map(function(key) {
        return {name:key,value:tmp[key]};
      });

      if(j<max_categories) {
        // categories data
        this.set('attr.isCategory',true);
      } else {
        if(this.description.value.type == "string" && 
           this.description.value.format == "date") {
          this.set('attr.isDate',true);
          var min_date = new Date();
          var max_date = new Date(1970,1,1);
          for(var i=0;i<response.length;i++) {
            var tmp_date = new Date(response[i][this.description.name]);
            if(tmp_date.getTime() >= max_date.getTime()) {
              max_date = tmp_date;
            }
            if(tmp_date.getTime() <= min_date.getTime()) {
              min_date = tmp_date;
            }
          }
          this.set('attr.start_date',min_date);
          this.set('attr.end_date',max_date);
        } else if(this.description.value.type == "string"){
          this.set('attr.isText',true);
          
        }
      }
    },
    _handleNullRequest: function() {
      if(this.$.nullWorker.lastResponse.count > 0) {
        this.set('attr.nullExist',true);
      }
    },
    _handleNullSelect: function(e) {
      var tmp = {};
      tmp[this.description.name]=null;
      if(e.srcElement.checked) {
        if(!this.query) {
          this.query = {'or':[]};
        }
        this.query.or.push(tmp);
      } else {
        var remove_idx = -1;
        for(var i=0;i<this.query.or.length;i++) {
          if(this.query.or[i][this.description.name] == null) {
             remove_idx = i;
          }
        }
        if(remove_idx!=-1) {
          this.query.or.splice(remove_idx,1);
        }
      }
      if(this.query.or.length == 0){
        this.query = null;
      }
      var obj = {
        'attr':this.description.name,
        'query':this.query,
        'model':this.model
      };
      this.fire('filter',obj);
      
    },
    _handleCategorySelect: function(e) {
      var attr_values = e.target.innerText.split(' ');
      var tmp = {};
      tmp[this.description.name]=attr_values[1];
      if(e.srcElement.checked) {
        if(!this.query) {
          this.query = {'or':[]};
        }
        this.query.or.push(tmp);
      } else {
        var remove_idx = -1;
        for(var i=0;i<this.query.or.length;i++) {
          if(this.query.or[i][this.description.name] == tmp[this.description.name]) {
             remove_idx = i;
          }
        }
        if(remove_idx!=-1) {
          this.query.or.splice(remove_idx,1);
        }
      }
      if(this.query.or.length == 0){
        this.query = null;
      }
      var obj = {
        'attr':this.description.name,
        'query':this.query,
        'model':this.model
      };
      this.fire('filter',obj);
    },
    _handleDateSelect: function(e){
      var s_date = e.detail.start;
      var e_date = e.detail.end;
      if(!this.query) {
        this.query = {};
      }
      if(s_date && e_date){
        this.query[this.description.name] = {'between':[]}
        this.query[this.description.name].between.push(s_date);
        this.query[this.description.name].between.push(e_date);
      }
      else if(s_date){
        this.query[this.description.name] = {'gt': s_date}
      }
      else if(e_date){
        this.query[this.description.name] = {'lt':e_date}
      }
      else{
        return;
      }
      var obj = {
        'attr':this.description.name,
        'query':this.query,
        'model':this.model
      };
      this.fire('filter',obj);
    },
    _handleTextChanged: function(e){
      if(!this.query) {
        this.query = {};
      }
      this.query[this.description.name] = { like:e.target.value };
      var obj = {
        'attr':this.description.name,
        'query':this.query,
        'model':this.model
      };
      this.fire('filter',obj);
    },
    _propertyToString: function(obj) {
      return obj.name+' ('+obj.value.type+')';
    }
  });
</script>
