<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/gold-cc-expiration-input/gold-cc-expiration-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="attr-filter">
  <template>
    <iron-ajax id="worker" 
      handle-as="json"
      on-response="_handleRequest">
    </iron-ajax>
    <paper-checkbox id="checkbox" on-change="_handleSelect">
      <span>{{_propertyToString(description)}}</span>
    </paper-checkbox>
    <div id="valuePanel">
      <template is="dom-if" if="{{attr.isCategory}}">
        <h4>Type: Category</h4>
        <template is="dom-repeat" items="{{content}}">
         <p>
         &nbsp;&nbsp;&nbsp;
         <paper-checkbox on-change="_handleCategorySelect">
          <span>{{item.name}}</span> &nbsp;
          (<span>{{item.value.count}}</span>)
         </paper-checkbox>
         </p>
        </template>
      </template>
      
      <template is="dom-if" if="{{attr.isDate}}">
        <div style="padding-left:20px;">
          <gold-cc-expiration-input 
            label="Start date filter"
            value={{startDate}}
            error-message="Please enter a valid date">
          </gold-cc-expiration-input><br />
          <gold-cc-expiration-input 
            label="End date filter"
            value={{endDate}}
            error-message="Please enter a valid date">
          </gold-cc-expiration-input><br />
          <paper-button raised on-click="_handleDateSelect">OK</paper-button>
        </div>
      </template>
        
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'attr-filter',
    properties: {
      description : {
        type: Object,
        notify: true
      },
      model: String,
      query: {
        type: Object,
        notify:true
      },
      resource : String,
      attr : {
        type: Object,
      },
      content: {
        type: Object,
        notify: true
      }
    },
    ready: function() {
    },
    _handleSelect : function(e) {
      if(this.description.value.type == "string" && this.description.value.format == "date"){
        this.attr = {isDate:true};
        return;
      }
      
      if(!this.$.checkbox.checked) {
        this.$.valuePanel.style.display = 'none';
      } else {
        this.$.valuePanel.style.display = 'block';
      }
      if(this.$.checkbox.checked && !this.content) {
        var query = {fields:{}};
        query.fields[this.description.name] = true;
        this.content = [];
        this.$.worker.url = this.resource+'?filter='+JSON.stringify(query);
        this.$.worker.generateRequest();
      }
    },
    _handleRequest : function() {
      var response = this.$.worker.lastResponse;
      var tmp = {};
      var max_categories = 50;
      var j=0;
      for(var i=0;i<response.length&&j<max_categories;i++) {
        if(!tmp[response[i][this.description.name]]) {
          tmp[response[i][this.description.name]] = {count:0};
          j++;
        }
        tmp[response[i][this.description.name]].count++;
      }

      this.content = Object.keys(tmp).map(function(key) {
        return {name:key,value:tmp[key]};
      });

      if(j<max_categories) {
        // categories data
        this.attr = {isCategory:true};
      }
    },
    _handleCategorySelect: function(e) {
      var attr_values = e.target.innerText.split(' ');
      var tmp = {};
      tmp[this.description.name]=attr_values[1];
      if(e.srcElement.checked) {
        if(!this.query) {
          this.query = {'or':[]};
        }
        this.query.or.push(tmp);
      } else {
        var remove_idx = -1;
        for(var i=0;i<this.query.or.length;i++) {
          if(this.query.or[i][this.description.name] == tmp[this.description.name]) {
             remove_idx = i;
          }
        }
        if(remove_idx!=-1) {
          this.query.or.splice(remove_idx,1);
        }
      }
      var obj = {
        'attr':this.description.name,
        'query':this.query,
        'model':this.model
      };
      this.fire('filter',obj);
    },
    _handleDateSelect: function(){
      if(this.startDate && this.endDate){
        this.query = {};
        this.query[this.description.name] = {'between':[]}
        var tmpStartDate = '20' + this.startDate.split('/')[1] + '-' + this.startDate.split('/')[0] + '-01';
        var tmpEndDate = '20' + this.endDate.split('/')[1] + '-' + this.endDate.split('/')[0] + '-01';
        this.query[this.description.name].between.push(tmpStartDate);
        this.query[this.description.name].between.push(tmpEndDate);
        var obj = {
          'attr':this.description.name,
          'query':this.query,
          'model':this.model
        };
        this.fire('filter',obj);
      }
    },
    _propertyToString: function(obj) {
      return obj.name+' ('+obj.value.type+')';
    }
  });
</script>
