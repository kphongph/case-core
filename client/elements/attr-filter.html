<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="date-filter.html">
<link rel="import" href="hidden-ele.html">
<link rel="import" href="view-property.html">

<dom-module id="attr-filter">
  <style>
    .browse{
      padding-left: 20px;
    }
    paper-button{
      font-size: 90%;
    }
    paper-button.blue {
      color: var(--paper-light-blue-500);
      --paper-button-flat-focus-color: var(--paper-light-blue-50);
    }
    paper-button.blue:hover {
      background: var(--paper-light-blue-50);
    }
  </style>
  <template>
    <iron-ajax id="worker" 
      handle-as="json"
      on-response="_handleRequest">
    </iron-ajax>

    <iron-ajax id="nullWorker" 
      handle-as="json"
      on-response="_handleNullRequest">
    </iron-ajax>
    
    <view-property 
    on-view-done="_handleViewPropertyDone"
    on-view-filter="_handleViewPropertyFilter"
    id="viewProperty"></view-property>

    <span>{{_propertyToString(description)}}</span>
    <paper-button 
      name$="{{description.name}}"
      type="{{description.value.type}}"
      tabindex="0" class="blue ripple"
      on-click="_handleView">View</paper-button>
    
  </template>
</dom-module>

<script>
  Polymer({
    is: 'attr-filter',
    properties: {
      description : {
        type: Object,
        notify: true
      },
      model: String,
      query: {
        type: Object,
        notify:true
      },
      resource : String,
      attr : {
        type: Object,
        notify:true,
      },
      jobValue: Object
    },
    ready: function() {
    },
    _handleView : function(e) {
      this.$.viewProperty.name = e.target.parentNode.name;
      this.$.viewProperty.open();
      
      if(!this.content) {
        this.content = [];
        this.set('attr',{});

        // check null
        var query_null = {};
        query_null[this.description.name] = null;
        this.$.nullWorker.url = this.resource+'/count?where='+JSON.stringify(query_null);
        this.$.nullWorker.generateRequest();
        
        // query all without null
        var query = {fields:{},where:{}};
        query.fields[this.description.name] = true;
        query.where[this.description.name] = {'neq':null};
        this.$.worker.url = this.resource+'?filter='+JSON.stringify(query);
        this.$.worker.generateRequest();
      }
    },
    _handleViewPropertyDone: function(e){
      this.attr = e.target.attr;
      this.fire('attr-done');
    },
    _handleViewPropertyFilter: function(e){
      this.fire('filter', e.detail);
    },
    _handleRequest : function() {
      var response = this.$.worker.lastResponse;
      if(response){
        this.$.viewProperty.updateProgress(response, this.description, this.model);
      }
    },
    _handleNullRequest: function() {
      if(this.$.nullWorker.lastResponse.count > 0) {
        this.$.viewProperty.isNull = true;
        this.set('attr.nullExist',true);
      }
      else{
        this.$.viewProperty.isNull = false;
      }
    },
    _handleNullSelect: function(e) {
      var tmp = {};
      tmp[this.description.name]=null;
      if(e.srcElement.checked) {
        if(!this.query) {
          this.query = {'or':[]};
        }
        this.query.or.push(tmp);
      } else {
        var remove_idx = -1;
        for(var i=0;i<this.query.or.length;i++) {
          if(this.query.or[i][this.description.name] == null) {
             remove_idx = i;
          }
        }
        if(remove_idx!=-1) {
          this.query.or.splice(remove_idx,1);
        }
      }
      if(this.query.or.length == 0){
        this.query = null;
      }
      var obj = {
        'attr':this.description.name,
        'query':this.query,
        'model':this.model
      };
      this.fire('filter',obj);
    },
    _propertyToString: function(obj) {
      return obj.name+' ('+obj.value.type+')';
    },
    doJob: function(job){
      var property = job.value.property;
      if(!property.skip){
        if(!property.value){
          this.$.isNull.selected = true;
          this.$.isNull.fire('change');
        }
        else{
          this.jobValue = JSON.parse(JSON.stringify(property));
          if(this.attr.isCategory){
            var all = this.$.categoryPanel.getElementsByTagName('paper-checkbox');
            if(all.length > 0){
              for( var i = 0; i < all.length; i++){
                if(all[i].value == this.jobValue.value){
                  all[i].checked = true;
                  all[i].fire('change');
                  break;
                }
              }
            }
          }
          else if(this.attr.isText || this.attr.isNumber){
            var input = this.$.inputPanel.getElementsByTagName('paper-input');
            if(input.length == 1){
              input[0].value = property.value;
              input[0].fire('input');
            }
          }
          else if(this.attr.isDate){
            var input = this.$.datePanel.getElementsByTagName('date-filter');
            if(input.length == 1){
              input[0].doJob(property);
            }
          }
        }
      }
      else{
        this.$.checkboxRoot.checked = true;
        this.$.checkboxRoot.fire('change');
      }
    },
    _hiddenReady: function(e){
      if(this.jobValue){
        if(this.attr.isCategory){
          var cb = Polymer.dom(e.target).parentNode.querySelector('paper-checkbox');
          if(cb.value == this.jobValue.value){
            cb.checked = true;
            cb.fire('change');
          }
        }
        else if(this.attr.isText || this.attr.isNumber){
          var input = Polymer.dom(e.target).parentNode.querySelector('paper-input');
          input.value = this.jobValue.value;
          input.fire('input');
        }
        else if(this.attr.isDate){
          var input = Polymer.dom(e.target).parentNode.querySelector('date-filter');
          input.doJob(this.jobValue);
        }
      }
    },
    _handleViewProperty: function(e){
      console.log(e.target.name)
      this.$.viewProperty.name = e.target.name;
      this.$.viewProperty.open();
    }
  });
</script>
