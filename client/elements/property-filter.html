<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<dom-module id="property-filter">
  <style>
    paper-material{
      width: 100%;
      margin-bottom: 5px;
    }
    .detailItem{
      @apply(--layout-horizontal);
      @apply(--layout-justified);
    }
    .detailItem:hover{
      color: #4CAF50;
      background-color: var(--google-grey-80);
    }
    .detailItem paper-button{
      width: 50px;
    }
    .detailItem .desc-name{
      margin-top: 12px;
      @apply(--layout-horizontal);
    }
    .detailItem .desc-name .desc-model{
      padding-left: 10px;
      margin-top: 4px;
      font-size: 70%;
    }
    .detailItem .desc-name .desc-property{
      margin-top: -2px;
      font-size: 110%;
    }
    paper-button{
      min-width: 100px;
      font-size: 90%;
    }
    paper-button.blue {
      color: var(--paper-light-blue-500);
      --paper-button-flat-focus-color: var(--paper-light-blue-50);
    }
    paper-button.blue:hover {
      background: var(--paper-light-blue-50);
    }
    .detail{
      height: 350px;
      border-collapse: collapse;
      border: 1px solid #e5e5e5;
    }
    .detail paper-checkbox{
      padding: 10px;
    }
    paper-progress.green {
      --paper-progress-active-color: var(--paper-light-green-500);
      --paper-progress-secondary-color: var(--paper-light-green-100);
      width: 100%;
      position: absolute;
      top: 2px;
    }
    .content{
      @apply(--layout-horizontal);
      @apply(--layout-justified);
      height: 100%;
      width: 100%;
    }
    .content:hover paper-fab{
      visibility: visible;
    }
    .content paper-fab{
      margin-top: 20%;
      visibility: hidden;
      width: 50px;
    }
    .content .center{
      width: 100%;
      height: 200px;
      overflow-y: hidden;
    }
    .content .center paper-checkbox{
      @apply(--layout-horizontal);
      padding: 15px 8px 0 8px;
    }
    .null{
      padding: 10px 0 0 40px;
      font-weight: bold;
    }
  </style>

  <template>
    <iron-ajax id="nullWorker" 
      handle-as="json"
      on-response="_handleNullRequest">
    </iron-ajax>
    
    <iron-ajax id="loadProperty"
      handle-as="json"
      on-response="_handleProperty">
    </iron-ajax>
    
    <paper-material elevation="1">
      <div class="detailItem">
        <div class="desc-name">
          <div class="desc-model">{{_getDescriptionModel(property_description)}}</div>.
          <div class="desc-property">{{_getDescriptionProperty(property_description)}}</div>
        </div>
        <paper-button
          tabindex="0" class="blue ripple"
          on-click="_handleFilter">Filter<iron-icon icon$="{{expandIcon}}"></iron-icon></paper-button>
      </div>
      <paper-progress 
        hidden$="{{!isLoading}}" value="{{value}}" 
        indeterminate="true" max="{{maxValue}}" class="green">
      </paper-progress>
    </paper-material>
    <div class="detail" hidden$="{{!isExpand}}">
      
      <div hidden$="{{!isNull}}" class="null">
        <paper-checkbox>Null</paper-checkbox>
      </div>
      
      <div class="content">
        <paper-fab mini icon="chevron-left" on-click="_handleBack"></paper-fab>
        <div class="center" flex>
          <hr>
          <template is="dom-repeat" items="{{result}}">
            <paper-checkbox>{{item.name}}</paper-checkbox>
          </template>
        </div>
        <paper-fab mini icon="chevron-right" on-click="_handleNext"></paper-fab>
      </div>
      
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'property-filter',
    properties: {
      property_description: String,
      property: Object,
      isExpand: Boolean,
      isLoading: Boolean,
      value: Number,
      maxValue: Number,
      taskList: Array,
      content: {
        type: Object,
        notify: true
      },
      attr : {
        type: Object,
        notify:true
      },
      isNull: Boolean,
      pageIndex: Number,
      maxValuePerPage: {
        type: Number,
        value: 5
      },
      expandIcon: {
        type: String,
        value: 'expand-more'
      }
    },
    ready: function(){
      this.isExpand = false;
      this.isLoading = false;
    },
    _getDescriptionModel: function(property_description){
      return property_description.model;
    },
    _getDescriptionProperty: function(property_description){
      return property_description.property;
    },
    _swapExpandIcon: function(){
      if(this.expandIcon == 'expand-more'){
        this.expandIcon = 'expand-less';
      }
      else{
        this.expandIcon = 'expand-more';
      }
    },
    _handleFilter: function(e){
      if(!this.isExpand){
        if(!this.content){
          this.isLoading = true;
  
          // check null
          var query_null = {};
          query_null[this.property_description.property] = null;
          this.$.nullWorker.url = '/api/' + this.property_description.model + '/count?where=' + JSON.stringify(query_null);
          this.$.nullWorker.generateRequest();
        
          // query all without null
          var query = {fields:{},where:{}};
          query.fields[this.property_description.property] = true;
          query.where[this.property_description.property] = {'neq':null};
          this.$.loadProperty.url = '/api/' + this.property_description.model + '?filter='+JSON.stringify(query);
          this.$.loadProperty.generateRequest();
        }
        else{
          this.isExpand = !this.isExpand;
          this._swapExpandIcon();
        }
      }
      else{
        this.isExpand = !this.isExpand;
        this._swapExpandIcon();
      }
    },
    _handleNullRequest: function() {
      if(this.$.nullWorker.lastResponse.count > 0) {
        this.isNull = true;
        this.set('attr.nullExist',true);
      }
      else{
        this.isNull = false;
      }
    },
    _updateProgress: function(){
      if(this.value != this.maxValue){
        this.value += 1;
      }
    },
    _cancelTask: function(){
      for(var i=this.taskList.length;i>0;i--) {
        this.cancelAsync(this.taskList[i]);
      }
    },
    _handleProperty: function(){
      var values = this.$.loadProperty.lastResponse;
      this.maxValue = values.length;
      var tmp = {};
      var max_categories = 50;
      var j=0;
      this.taskList = [];
      for(var i=0;i<values.length;i++) {
        this.taskList.push(this.async(this._updateProgress, true));
        if(!tmp[values[i][this.property_description.property]]) {
          tmp[values[i][this.property_description.property]] = {count:0};
          j++;
        }
        tmp[values[i][this.property_description.property]].count++;
      }
      this.content = Object.keys(tmp).map(function(key) {
        return {name:key,value:tmp[key]};
      });
      if(this.content){
        this._cancelTask();
      }
      this.set('attr',{});
      if(j<max_categories) {
        this.set('attr.isCategory',true);
      } else {
        if(this.property_description.value.type == "string" && 
           this.property_description.value.format == "date") {
          this.set('attr.isDate',true);
          var min_date = new Date();
          var max_date = new Date(1970,1,1);
          for(var i=0;i<values.length;i++) {
            var tmp_date = new Date(values[i][this.property_description.name]);
            if(tmp_date.getTime() >= max_date.getTime()) {
              max_date = tmp_date;
            }
            if(tmp_date.getTime() <= min_date.getTime()) {
              min_date = tmp_date;
            }
          }
          this.set('attr.start_date',min_date);
          this.set('attr.end_date',max_date);
        } else if(this.property_description.value.type == "string"){
          this.set('attr.isText',true);
        } else if(this.property_description.value.type == "number"){
          this.set('attr.isNumber',true);
        }
      }
      this.isLoading = false;
      this.isExpand = true;
      this._swapExpandIcon();
      this._showResult();
    },
    _showResult: function(){
      if(!this.content){
        return;
      }
      if(!this.pageIndex){
        this.pageIndex = 1;
      }
      this.pageCount = Math.ceil(this.content.length/this.maxValuePerPage);
      var tmp = [];
      var start = (this.pageIndex-1) * this.maxValuePerPage;
      var end = start + this.maxValuePerPage;
      if(end > this.content.length){
        end = this.content.length;
      }
      for(var i = start; i < end; i++){
        tmp.push({
          'value':this.content[i].name,
          'name':this.content[i].name + ' (' + this.content[i].value.count + ')'
          });
      }
      this.result = tmp;
    },
    _handleBack: function(){
      if(this.pageIndex > 1){
        this.pageIndex -= 1;
        this._showResult();
      }
    },
    _handleNext: function(){
      if(this.pageIndex + 1 <= this.pageCount){
        this.pageIndex += 1;
        this._showResult();
      }
    }
  });
</script>