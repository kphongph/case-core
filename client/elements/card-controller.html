<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="summary-card.html">
<link rel="import" href="i-report.html">

<dom-module id="card-controller">

  <style>
    :host {
      display: block;
      @apply(--layout-vertical);
    }
    .container {
      width: 100%;
      height: 100%;
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
    }
    .container summary-card{
      padding: 10px;
    }
    paper-fab{
      position: absolute;
      top: 20px;
      left: 20px;
    }
  </style>

  <template>
    <iron-ajax id="ajax" on-response="_handleResponse"></iron-ajax>
    <iron-ajax id="cmajax" on-response="_handleCMResponse"></iron-ajax>
    <div class="container" hidden$="{{isChart}}">
      <template is="dom-repeat" items="{{services}}">
        <summary-card 
        header="{{item.header}}"
        title="{{item.title}}"
        value="{{item.value}}"
        unit="{{item.unit}}"
        description="{{item.description}}"
        url="{{item.services}}"
        on-click="_cardClicked"></summary-card>
      </template>
    </div>
    <div hidden$="{{!isChart}}">
      <paper-fab id="backMenu" mini icon="arrow-back" on-click="_backMenuClicked"></paper-fab>
      <i-report url="{{url}}" cmservices={{cmservices}}></i-report>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'card-controller',
    ready: function(){
      this.isChart = false;
      this.hostid = "3720140208";
      this.index = 0;
      this.$.cmajax.url = "http://newbintest.azurewebsites.net/ServiceControl/Service.svc/GetSchoolReportVsHost?host=3720140208&year=2015";
      this.$.cmajax.generateRequest();
    },
    properties: {
      services: {
        type: Array,
        value: []
      },
      cmservices: Object,
      url: String,
      isChart: Boolean,
      hostid: String,
      index: Number,
      tmpResult: Array
    },
    _getServiceResult: function(obj){
      if(obj){
        var key = Object.keys(obj)[0];
        if(key == 0){
          return obj[key][Object.keys(obj[key])];
        }
        else{
          return obj[key];
        }
      }
    },
    _cardClicked: function(e){
      this.isChart = !this.isChart;
      var tmpUrl = e.target.getAttribute('url');
      if(!tmpUrl){
        tmpUrl = e.target.parentElement.getAttribute('url');
      }
      this.url = tmpUrl;
    },
    _backMenuClicked: function(){
      this.isChart = !this.isChart;
    },
    _handleCMResponse: function(e){
      this.cmservices = e.detail.response;
      this.$.ajax.url = "../data/cards.json";
      this.$.ajax.generateRequest();
    },
    _handleResponse: function(e){
      var response = null;
      if(e){
        response = e.detail.response;
      }
      if(this.index == 0){
        this.tmpResult = response;
        this.index++;
      }
      else{
        var result = this._getServiceResult(response);
        if(this.index == this.tmpResult.length){
          this.tmpResult[this.index-1].value = result;
          this.services = this.tmpResult;
          this.index++;
        }
        else{
          if(result){
            this.tmpResult[this.index-1].value = result;
          }
          this.index++;
        }
      }
      if(this.tmpResult){
        if(this.tmpResult.length >= this.index){
          var api = this.tmpResult[this.index-1].api;
          var where = this.tmpResult[this.index-1].where;
          
          if(api){
            if(api == "cmservices"){
              var value = {'detail':
                {
                  'response': {
                    'count': this.evalSelector(where, JSON.parse(this.cmservices))
                  }
                }};
              this._handleResponse(value);
            }
            else{
              where = where.replace("_hostid", this.hostid);
              this.$.ajax.url = api + "?where=" + where;
              this.$.ajax.generateRequest();
            }
          }
          else{
            this._handleResponse(null);
          }
        }
      }
    },
    evalSelector: function(selector, jsonData){
      var tokens = this.splitter(selector);
      var resultStr = "selector";
      for(var i = 0; i < tokens.length; i++){
        if(isNaN(tokens[i])){
          if(tokens[i].indexOf('[...]') == -1 && tokens[i].indexOf('where') == -1){
            resultStr += '.replace("' + tokens[i] + '", ' + 'Number(eval("jsonData" + "' + tokens[i] + '")))';
          }
          else{
            if(tokens[i].indexOf('[...]') != -1){ // all in array
              var length = eval("jsonData" + tokens[i].split('[')[0] + ".length");
              resultStr += '.replace("' + tokens[i] + '", 0';
              for(var j = 0; j < length; j++){
                resultStr += '+Number(eval("jsonData' + tokens[i].replace("[...]", "[" + j + "]") + '"))';
              }
              resultStr += ')';
            }
            if(tokens[i].indexOf('where') != -1){ // where query
              var query = tokens[i].split('?where=');
              if(query){
                for(var j = 0; j < query.length; j++){
                  if(j%2 != 0){
                    var text = query[j].substring(0,query[j].indexOf(']')+1);
                    var list = JSON.parse(text.replace(/'/g, "\""));
                    for(var k = 0; k < list.length; k++){
                      var data = eval("jsonData" + query[j-1]);
                      var key = Object.keys(list[k]);
                      var value = list[k][key];
                      var index = -1;
                      for(var l = 0; l < data.length; l++){
                        if(data[l][key] === value){
                          index = l;
                          break;
                        }
                      }
                      query[j] = query[j].replace(text, "[" + index + "]");
                    }
                  }
                }
                resultStr += '.replace("' 
                  + tokens[i] + '", ' 
                  + 'Number(eval("jsonData" + "' 
                  + query.join('') + '")))';
              }
            }
          }
        }
      }
      try {
        return Number(eval(eval(resultStr))).toFixed(2);
      }
      catch(err) {
        console.log(selector + ' : ' + err.message);
        return 0;
      }
    },
    splitter: function(text){
      var separators = [' ', '\\\+', '-', '\\\(', '\\\)', '\\*', '/', ':', '\\\?'];
      var tokens = text.split(new RegExp(separators.join('|'), 'g'));
      return tokens.filter(function(n){ return n != "" });
    }
  });
</script>