<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="model-filter">
  <style>
    .container{
        width: 100%;
    }
    .container h2{
        padding-left: 15px;
    }
    paper-checkbox{
        padding: 15px 0 10px 15px;
    }
    paper-dialog {
        min-width: 350px;
    }
    .list{
        height: 300px;
        overflow-y:auto;
    }
  </style>
  <template>
    <iron-ajax id="modelsAjax" 
      handle-as="json"
      url="{{url}}"
      auto
      on-response="_handleModels">
    </iron-ajax>
    
    <iron-ajax id="attrAjax" 
      handle-as="json"
      on-response="_handleAttributes">
    </iron-ajax>
    
    <div class="container">
      <paper-dialog class="dialog-panel" id="dialogModels">
        <div class="dialog-body">
          <h2>All models</h2>
          <div class="list" id="checkboxList">
            <template is="dom-repeat" items="{{models}}">
              <paper-checkbox on-change="handleCheckbox" url="{{item.url}}">{{item.name}}</paper-checkbox><br>
            </template>
          </div>
        </div>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm autofocus on-click="_handleModelsConfirm">OK</paper-button>
        </div>
      </paper-dialog>
    </div>
    
  </template>
</dom-module>

<script>
  Polymer({
    is: 'model-filter',
    properties: {
      models: {
        type: Array
      },
      urls: {
        type: Array,
        notify: true
      },
      selectedModels: Array,
      isJob: Boolean
    },
    ready: function() {

    },
    show: function(){
        this.$.dialogModels.open();
    },
    _handleModelsConfirm: function(){
      for(var i = 0; i < this.urls.length; i++){
        this.$.attrAjax.url = '' + this.urls[i];
        this.$.attrAjax.generateRequest();
      }
    },
    _handleAttributes: function(e){
      var response = e.detail.__data__.response;
      if(response){
        var model = response.resourcePath.substr(1);
        for(var i = 0; i < this.selectedModels.length; i++){
          if(this.selectedModels[i].model == model && this.selectedModels[i].attr == null){
            var key = Object.keys(response.models)[0];
            this.selectedModels[i].attr = Object.keys(response.models[key].properties);
          }
        }
      }
      var complete = true;
      for(var i = 0; i < this.selectedModels.length; i++){
        if(this.selectedModels[i].attr == null){
          complete = false; break;
        }
      }
      if(complete){
        this.fire('confirm', this.selectedModels);
      }
    },
    _handleModels: function(){
      var models = this.$.modelsAjax.lastResponse;
      if(models){
        var apis = models.apis;
        if(apis){
          var tmp = [];
          for(var i = 0; i < apis.length; i++){
            var obj = {
              "name":apis[i].path.split('/')[1],
              "url":"/explorer/resources" + apis[i].path,
              "attr":null
            }
            tmp.push(obj);
          }
          this.models = tmp;
        }
      }
    },
    handleCheckbox: function(e){
      var url = e.target.url;
      if(!this.urls){
        this.urls = [];
      }
      if(!this.selectedModels){
        this.selectedModels = [];
      }
      if(e.target.checked){
        var isExist = false;
        for(var i = 0; i < this.urls.length; i++){
          if(this.urls[i] == url){
            isExist = true;
            break;
          }
        }
        if(!isExist){
          this.urls.push(url);
          this.selectedModels.push({'model':url.split('/').pop(),'attr':null});
        }
      }
      else{
        var index = this.urls.indexOf(url);
        if(index != -1){
          this.urls.splice(index, 1);
          this.selectedModels.splice(index, 1);
        }
      }
      this.urls.slice();
    },
    doJob: function(job){
      // do work
      var cbList = Polymer.dom(this.$.checkboxList).querySelectorAll('paper-checkbox');
      for(var i = 0; i < cbList.length; i++){
        if(cbList[i].innerText.trim().toLowerCase() == job.value.toLowerCase()){
          cbList[i].checked = true;
          cbList[i].fire('change');
          break;
        }
      }
      this.fire('confirm', this.urls);
    }
  });
</script>
