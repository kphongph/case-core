<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="property-filter.html">

<dom-module id="model-config">
  <style>
    .container{
      background-color: #FFFFFF;
      border-collapse: collapse;
      border: 1px solid #e5e5e5;
    }
    .container:hover{
      color: #4CAF50;
      background-color: var(--google-grey-100);
    }
    .item-header{
      @apply(--layout-horizontal);
      @apply(--layout-justified);
    }
    .item-header span{
      padding: 15px 0 15px 0;
    }
    .expand-button {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .detail{
      display: none;
      margin-left: 50px;
      margin-right: 20px;
      padding-bottom: 10px;
    }
    paper-menu {
      display: block;
    }
    paper-menu-button {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .item {
      max-width: 100px;
    }
  </style>
  <template>
    <iron-ajax id="getDescription"
      handle-as="json"
      on-response="_handleDescription">
    </iron-ajax>
    
    <iron-ajax id="countAjax" 
      handle-as="json"
      on-response="_handleCount">
    </iron-ajax>
    
    <div class="container">
      <div class="item-header">
        <div class="expand-button">
          <paper-icon-button
            icon="chevron-right"
            on-click="_handleExpand">
          </paper-icon-button>
        </div>
        <span>{{_modelsToString(currentModels)}}</span>
        <paper-menu-button horizontal-offset="-150" vertical-offset="20">
          <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
          <paper-menu class="dropdown-content" selected="{{addModel}}">
            <template is="dom-repeat" items="[[otherModels]]">
              <paper-item>[[item]]</paper-item>
            </template>
          </paper-menu>
        </paper-menu-button>
      </div>
        <div class="detail">
          <template is="dom-repeat" items="{{model_properties}}">
            <property-filter property_description="{{item}}"></property-filter>
          </template>
        </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'model-config',
    properties: {
      currentModels: {
        type: Array,
        observer: '_modelChange'
      },
      model_properties: Array,
      where: {
        type: Object,
        notify: true
      },
      records: {
        type: String,
        notify: true
      },
      addModel: {
        type: Number,
        observer: '_addModelChange'
      },
      otherModels: {
        type: Array
      }
    },
    ready: function() {
      
    },
    _modelsToString: function(currentModels){
      if(currentModels.length > 1){
        return currentModels.join(' AND ');
      }
      else{
        return currentModels;
      }
    },
    _modelChange: function(){
      this.model_properties = [];
      for(var i = 0; i < this.currentModels.length; i++){
        this.$.getDescription.url = 'explorer/resources/' + this.currentModels[i];
        this.$.getDescription.generateRequest();
      }
    },
    _handleDescription : function(e) {
      var model_description = e.detail.__data__.response;
      if(!model_description) return;
      var key = Object.keys(model_description.models)[0];
      var obj = model_description.models[key].properties;
      var modelName = model_description.resourcePath.slice(1);
      if(!this.model_properties){
        this.model_properties = Object.keys(obj).map(function(key) {
          return {model:modelName,property:key,value:obj[key]};
        });
      }
      else{
        var tmp = Object.keys(obj).map(function(key) {
          return {model:modelName,property:key,value:obj[key]};
        });
        this.model_properties = this.model_properties.concat(tmp);
      }
      this.where = {'and':[]};
      this._computeReturnRecords(model_description.resourcePath, this.where);
    },
    _computeReturnRecords: function(modelName, where) {
      if(where.and.length > 0){
        this.$.countAjax.url = '/api' + modelName + '/count?where='+encodeURI(JSON.stringify(where));
        this.$.countAjax.generateRequest();
      } else {
        this.$.countAjax.url = '/api' + modelName +'/count';
        this.$.countAjax.generateRequest();
      }
    },
    _handleCount : function(e) {
      if(!this.records){
        this.records = e.detail.__data__.response.count;
      }
      else{
        this.records += e.detail.__data__.response.count;
      }
      //console.log(this.records)
      //this.fire('done');
    },
    _handleExpand: function(e){
      var target = this._findUntil(e.target, 'paper-icon-button', 5);
      var detail = target.parentNode.parentNode.nextElementSibling;
      if(target.icon == 'chevron-right'){
        target.icon = 'expand-more';
        detail.style.display = 'block';
      }
      else{
        target.icon = 'chevron-right';
        detail.style.display = 'none';
      }
    },
    _findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{
          element = element.parentNode;
        }
      }
      return null;
    },
    _addModelChange: function(e){
      var tmp = this.currentModels.slice();
      tmp.push(this.otherModels[e]);
      this.fire('new-model', tmp);
    }
  });
</script>
