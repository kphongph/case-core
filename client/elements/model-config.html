<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="property-filter.html">

<dom-module id="model-config">
  <style>
    .item{
      @apply(--layout-vertical);
      background-color: #FFFFFF;
      border-collapse: collapse;
      border: 1px solid #e5e5e5;
    }
    .item .item-header{
      @apply(--layout-horizontal);
      @apply(--layout-justified);
      padding: 10px;
    }
    .item paper-checkbox{
      padding: 10px;
    }
    .item .item-header:hover{
      color: #4CAF50;
      background-color: var(--google-grey-100);
    }
    .detail{
      display: none;
      margin-left: 50px;
      margin-right: 20px;
    }
  </style>
  <template>
    <iron-ajax id="getDescription"
      handle-as="json"
      on-response="_handleDescription">
    </iron-ajax>
    
    <iron-ajax id="countAjax" 
      handle-as="json"
      on-response="_handleCount">
    </iron-ajax>
    
    <div class="container">
      <div class="item">
        <div class="item-header">
          <div>
            <paper-checkbox></paper-checkbox>
            <span>{{_modelsToString(models)}}</span>
          </div>
          <paper-icon-button
            icon="expand-more"
            on-click="_handleExpand">
          </paper-icon-button>
        </div>
        <div class="detail">
          <template is="dom-repeat" items="{{model_properties}}">
            <property-filter property_description="{{item}}"></property-filter>
          </template>
        </div>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'model-config',
    properties: {
      models: {
        type: String,
        observer: '_modelChange'
      },
      model_properties: Array,
      where : {
        type: Object,
        notify: true
      },
      records : {
        type: String,
        notify: true
      }
    },
    ready: function() {
    },
    _modelsToString: function(models){
      if(models.length > 1){
        return models.join(' AND ');
      }
      else{
        return models;
      }
    },
    _modelChange: function(){
      for(var i = 0; i < this.models.length; i++){
        this.$.getDescription.url = 'explorer/resources/' + this.models[i];
        this.$.getDescription.generateRequest();
      }
    },
    _handleDescription : function() {
      var model_description = this.$.getDescription.lastResponse;
      var key = Object.keys(model_description.models)[0];
      var obj = model_description.models[key].properties;
      var modelName = model_description.resourcePath.slice(1);
      if(!this.model_properties){
        this.model_properties = Object.keys(obj).map(function(key) {
          return {model:modelName,property:key,value:obj[key]};
        });
      }
      else{
        var tmp = Object.keys(obj).map(function(key) {
          return {model:modelName,property:key,value:obj[key]};
        });
        this.model_properties = this.model_properties.concat(tmp);
      }
      this.where = {'and':[]};
      this._computeReturnRecords(model_description.resourcePath, this.where);
    },
    _computeReturnRecords: function(modelName, where) {
      if(where.and.length > 0){
        this.$.countAjax.url = '/api' + modelName + '/count?where='+encodeURI(JSON.stringify(where));
        this.$.countAjax.generateRequest();
      } else {
        this.$.countAjax.url = '/api' + modelName +'/count';
        this.$.countAjax.generateRequest();
      }
    },
    _handleCount : function() {
      if(!this.records){
        this.records = this.$.countAjax.lastResponse.count;
      }
      else{
        this.records += this.$.countAjax.lastResponse.count;
      }
      console.log(this.records)
      //this.fire('done');
    },
    _handleExpand: function(e){
      var target = this._findUntil(e.target, 'paper-icon-button', 5);
      var detail = target.parentNode.nextElementSibling;
      if(target.icon == 'expand-more'){
        target.icon = 'expand-less';
        detail.style.display = 'block';
      }
      else{
        target.icon = 'expand-more';
        detail.style.display = 'none';
      }
    },
    _findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{
          element = element.parentNode;
        }
      }
      return null;
    }
  });
</script>
