<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/host-ajax/host-ajax.html">
<link rel="import" href="../bower_components/personui-element/personui-element.html">
<link rel="import" href="../bower_components/hostperson-element/hostperson-element.html">

<dom-module id="host-person">
  <style>
    .container{
      @apply(--layout-vertical);
      @apply(--layout-center-justified);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: : center;
    }
    paper-card {
      width: 100%;
      margin-bottom: 16px;
    }
    .blue {
      --paper-card-header-color: #03A9F4;
    }
    .title{
      font-size: 26px;
    }
    .body{            
      height: 300px;
      @apply(--layout-vertical);
      overflow-y: auto;
    }
		.card-actions .action{
      @apply(--layout-horizontal);
			@apply(--layout-justified);
    }
    .item{
      height: 50px;
    }
    .item-body{
      @apply(--layout-horizontal);
			@apply(--layout-justified);
			padding: 15px;
    }
    .text{
      position: absolute;
      top: 25%;
      right: 55px;
    }
    paper-fab{
      position: absolute;
      top: 5px;
      right: 10px;
    }
    paper-spinner{
      position: absolute;
      top: 10px;
      right: 10px;
    }
    paper-fab.red {
      --paper-fab-background: var(--paper-red-500);
      --paper-fab-keyboard-focus-background: var(--paper-red-900);
    }
    paper-fab.green {
      --paper-fab-background: var(--paper-green-500);
      --paper-fab-keyboard-focus-background: var(--paper-green-900);
    }
    </style>
    <template>
      <hostperson-element id="hostperson" on-hostperson-success="_handleHostPerson"></hostperson-element>
		  <host-ajax id="hostAjax" on-host-ajax-success="_onHostSuccess"></host-ajax>
      <div class="container">
        <paper-card class="blue" animated-shadow>
          <div class="card-content">
            <div class="title" id="titleText">เลือกโรงเรียน <span>{{_hostToString(selectedHost)}}</span></div>
          </div>
				  <div class="card-actions">
				    <template is="dom-if" if="{{!multiple}}">
					    <paper-input label="ชื่อโรงเรียน..." on-input="_handleSearch"></paper-input>
					  </template>
					   
					  <template is="dom-if" if="{{multiple}}">
					    <personui-element on-datafromui='_personuiSuccess'></personui-element>
					  </template>
					  
				  </div>
          <div class="card-actions body" id="list">
            <template is="dom-if" if="{{!multiple}}">                        
              <template is="dom-repeat" items="{{hostList}}">
                <paper-material class="item" elevation="1">
                  <div class="item-body">
                    <paper-radio-button name="{{_getID(item)}}" on-change="_handleRadio">{{_getText(item)}}</paper-radio-button>
                  </div>
                </paper-material>
              </template>
            </template>
            <div id="itemDetails">
              <template is="dom-if" if="{{multiple}}">
                <template is="dom-repeat" items="{{personList}}">
  					  		<paper-material class="item" elevation="1">
  					  		  <div class="item-body">
  					  		    <div>{{item.text}}</div>
  					  		    <div>
  					  		      <paper-spinner name="{{_getID(item)}}" active></paper-spinner>
  					  		      <!-- <span name="{{_getID(item)}}" class="text">ตรวจสอบ...</span>  -->
  					  		      <paper-fab class="green" hidden mini icon="add" 
  					  		        name="{{_getID(item)}}" on-click="_handleSaveClick"></paper-fab>
  					  		      <paper-fab class="red" hidden mini icon="remove" value="" 
  					  		        name="{{_getID(item)}}" on-click="_handleRemove"></paper-fab>
  					  		    </div>
  					  		  </div>
  							  </paper-material>
                </template>
              </template>
            </div>
          </div>
          <div class="card-actions">
            <div class="action">
					  	<paper-button on-click="_handleLeftButton">{{leftText}}</paper-button>
						  <paper-button id="rightButton" on-click="_handleRightButton">เลือก</paper-button>						
            </div>
          </div>
        </paper-card>
      </div>
    </template>
</dom-module>

<script>
  Polymer({
    is: 'host-person',
    properties: {
      hostList: Array,
      personList: Array,
  	  selectedHost: Object,
      multiple: {
        type: Boolean,
        value: false
      },
  	  state: String,
  	  leftText: {
  		  type: String,
  		  value: 'ยกเลิก'
  	  },
  	  pageIndex: Number,
  	  pageLimit: {
  		  type: Number,
  		  value: 10
  	  },
  	  requestQueue: Array,
  	  personType: {
  	    type: String,
  	    value: "student"
  	  }
    },
    ready: function() {
  	  this.state = "select_host";
  	  this.$.hostAjax.search('', this.pageIndex, this.pageLimit);
    },
    _handleHostPerson: function(e){
      if(e.detail.event == 'checkExist'){
        this._handleCheckExist(e.detail);
      }
      else if(e.detail.event == 'insert'){
        this._handleAjaxSave(e.detail);
      }
      else if(e.detail.event == 'update'){
        this._handleAjaxRemove(e.detail);
      }
    },
    _hostToString: function(host){
  	  if(host.text){
  			return "(" + host.text + ")";
  		}
  		else{
  			return "";
  		}
  	},
  	_getID: function(obj){
  		var key = Object.keys(obj)[0];
  		return obj[key];
  	},
  	_getText: function(obj){
  		var key = Object.keys(obj)[1];
  		return obj[key];
  	},
  	_handleRadio: function(e){
  		this.selectedHost = {'id':e.target.name,'text':e.target.innerText.trim()};		
  		var radioGroup = this.$.list.querySelectorAll('paper-radio-button');
  		for(var i = 0; i < radioGroup.length; i++){
  			if(radioGroup[i].checked && radioGroup[i] != e.target){
  				radioGroup[i].checked = !radioGroup[i].checked;
  			}
  		}
  	},
  	_handleRightButton: function(e){
  		if(this.state == 'select_host'){			
  			this.multiple = true;
  			this._state_select_person();
  		}
  	},
  	_handleLeftButton: function(){
  		if(this.state == 'select_person'){
  			this.multiple = false;
  			this._state_select_host();
  		}
  		else{
  			// cancel
  		}
  	},
  	_state_select_host: function(){
  		this.leftText = "ยกเลิก";
  		this.$.rightButton.hidden = false;
  		this.state = 'select_host';
  		this.$.titleText.innerText = "เลือกโรงเรียน" + this._hostToString(this.selectedHost);
  	},
  	_state_select_person: function(){
  		this.leftText = "ย้อนกลับ";
  		this.$.rightButton.hidden = true;
  		this.state = 'select_person';
  		this.$.titleText.innerText = "เลือกนักเรียน" + this._hostToString(this.selectedHost);
  	},
  	_onHostSuccess: function(e){
  		if(e.detail){
  		  if(e.detail.data){
  		    var tmp = e.detail.data.map(function(obj){
  		      return {id:obj.id,text:obj.Name};
  		    });
  		    this.hostList = tmp.slice();
  		  }
  		}
  	},
  	_handleSearch: function(e){
  		this.pageIndex = 0;
  		this.$.hostAjax.search(e.target.value, this.pageIndex, this.pageLimit);
  	},
  	_updateStatus: function(id, count){
  	  this._hideShow('paper-spinner', id, false, 0);
  	  if(count == 0){
    	  this._hideShow('paper-fab.green', id, true, 500);
    	  this._hideShow('paper-fab.red', id, false, 500);
    	}
    	else{
    	  this._hideShow('paper-fab.green', id, false, 500);
    	  this._hideShow('paper-fab.red', id, true, 500);
    	}
  	  
  	  if(count > 0){
    	  this._setSpanText(id, 'มีอยู่');
    	}
    	else{
    	  this._setSpanText(id, 'นำเข้า');
    	}
  	},
  	_findElement: function(selector, compare){
  	  var elements = this.$.itemDetails.querySelectorAll(selector);
  	  for(var i = 0; i < elements.length; i++){
    		if(elements[i].name == compare){
    		  return elements[i];
    		}
  		}
  		return null;
  	},
  	_setSpanText: function(compare, text){
  	  var element = this._findElement('span', compare);
  	  if(element){
  	    element.innerText = text;
  	  }
  	},
  	_setFabValue: function(compare, value){
  	  var element = this._findElement('paper-fab.red', compare);
  	  if(element){
  	    if(value){
  	      element.setAttribute('value', value);
  	    }
  	  }
  	},
  	_getFabName: function(compare, value){
  	  var elements = this.$.itemDetails.querySelectorAll('paper-fab.red');
  	  for(var i = 0; i < elements.length; i++){
    		if(elements[i].getAttribute('value') == compare){
    		  return elements[i].name;
    		}
  		}
  		return null;
  	},
  	_hideShow: function(selector, compare, isShow, timeout){
  	  var element = this._findElement(selector, compare);
  	  if(element){
    	  if(selector == 'paper-spinner'){
      	  setTimeout(function(){ element.active = isShow; }, timeout);
      	}
      	else{
      	  setTimeout(function(){ element.hidden = !isShow; }, timeout);
      	}
  	  }
  	},
  	_checkExist: function(){
  	  if(this.requestQueue){
  	    if(this.requestQueue.length > 0){
  	      var personID = this.requestQueue.shift();
  	      this.$.hostperson.checkExist(this.selectedHost.id, personID);
  	    }
  	  }
  	},
  	_handleCheckExist: function(response){
  	  var count = 0;
  	  if(response.id){
  	    count = 1;
  	  }
  	  this._updateStatus(response.PersonID, count);
  	  this._setFabValue(response.PersonID);
  	  this._checkExist();
  	},
  	_handleSaveClick: function(e){
  	  var target = this._findUntil(e.target, 'paper-fab', 5);
  	  this._hideShow('paper-fab.green', target.name, false, 0);
  	  this._hideShow('paper-spinner', target.name, true, 0);
  	  this.$.hostperson.insert(this.selectedHost.id, target.name, this.personType, new Date());
  	},
  	_handleAjaxSave: function(response){
  	  if(response){
  	    this._setFabValue(response.PersonID, response.id);
  	    this._updateStatus(response.PersonID, 1);
  	  }
  	},
  	_handleRemove: function(e){
  	  var target = this._findUntil(e.target, 'paper-fab', 5);
  	  this._hideShow('paper-fab.red', target.name, false, 0);
  	  this._hideShow('paper-spinner', target.name, true, 0);
  	  this.$.hostperson.update(target.getAttribute('value'), null);
  	},
  	_handleAjaxRemove: function(response){
  	  if(response){
  	    this._updateStatus(this._getFabName(response.id), 0);
  	  }
  	},
  	_findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{ 
          element = element.parentNode;
        }
      }
      return null;
    },
    _personuiSuccess: function(e){
      if(this.personList){
        for(var i = 0; i < this.personList.length; i++){
          this._setSpanText(this.personList[i].key.trim(), 'ตรวจสอบ...');
          this._hideShow('paper-fab.green', this.personList[i].key, false, 0);
          this._hideShow('paper-fab.red', this.personList[i].key, false, 0);
    	    this._hideShow('paper-spinner', this.personList[i].key, true, 0);
        }
      }
      var tmp = e.detail.map(function(obj){
  		  return {
  		    key:obj.id,
  		    text:obj.CID + ' ' + obj.Title + ' ' + obj.FirstName + ' ' + obj.LastName
  		  };
  		});
  		this.personList = tmp.slice();
      tmp = this.personList.map(function(obj){
  		  return obj.key;
  		});
  		this.requestQueue = tmp.slice();
  		this._checkExist();
    }
  });
</script>