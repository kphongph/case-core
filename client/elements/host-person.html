<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/host-ajax/host-ajax.html">
<link rel="import" href="../bower_components/personui-element/personui-element.html">

<dom-module id="host-person">
  <style>
    .container{
      @apply(--layout-vertical);
      @apply(--layout-center-justified);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: : center;
    }
    paper-card {
      width: 100%;
      margin-bottom: 16px;
    }
    .blue {
      --paper-card-header-color: #03A9F4;
    }
    .title{
      font-size: 26px;
    }
    .body{            
      height: 300px;
      @apply(--layout-vertical);
      overflow-y: auto;
    }
		.card-actions .action{
      @apply(--layout-horizontal);
			@apply(--layout-justified);
    }
    .item{
      height: 50px;
    }
    .item-body{
      @apply(--layout-horizontal);
			@apply(--layout-justified);
			padding: 15px;
    }
    .grean{
      color: #4CAF50;
      position: absolute;
      top: 25%;
      right: 10px;
    }
    paper-fab{
      position: absolute;
      top: 5px;
      right: 10px;
    }
    paper-spinner{
      position: absolute;
      top: 10px;
      right: 10px;
    }
    </style>
    <template>
      <iron-ajax id="checkExist" 
        handle-as="json"
        on-response="_handleCheckExist">
      </iron-ajax>
      <iron-ajax id="saveAjax" 
        handle-as="json"
        method="POST"
        content-type="application/json"
        on-response="_handleAjaxSave">
      </iron-ajax>
		  <host-ajax id="hostAjax" on-host-ajax-success="_onHostSuccess"></host-ajax>
      <div class="container">
        <paper-card class="blue" animated-shadow>
          <div class="card-content">
            <div class="title" id="titleText">เลือกโรงเรียน <span>{{_hostToString(selectedHost)}}</span></div>
          </div>
				  <div class="card-actions">
				    <template is="dom-if" if="{{!multiple}}">
					    <paper-input label="ชื่อโรงเรียน..." on-input="_handleSearch"></paper-input>
					  </template>
					   
					  <template is="dom-if" if="{{multiple}}">
					    <personui-element on-datafromui='_personuiSuccess'></personui-element>
					  </template>
					  
				  </div>
          <div class="card-actions body" id="list">
            <template is="dom-if" if="{{!multiple}}">                        
              <template is="dom-repeat" items="{{hostList}}">
                <paper-material class="item" elevation="1">
                  <div class="item-body">
                    <paper-radio-button name="{{_getID(item)}}" on-change="_handleRadio">{{_getText(item)}}</paper-radio-button>
                  </div>
                </paper-material>
              </template>
            </template>
            <div id="itemDetails">
              <template is="dom-if" if="{{multiple}}">
                <template is="dom-repeat" items="{{personList}}">
  					  		<paper-material class="item" elevation="1">
  					  		  <div class="item-body">
  					  		    <div>{{item.text}}</div>
  					  		    <div>
  					  		      <paper-spinner name="{{_getID(item)}}" active></paper-spinner>
  					  		      <span hidden name="{{_getID(item)}}" class="grean">อยู่ในโรงเรียนแล้ว</span>
  					  		      <paper-fab hidden mini icon="add" name="{{_getID(item)}}" on-click="_handleSave"></paper-fab>
  					  		    </div>
  					  		  </div>
  							  </paper-material>
                </template>
              </template>
            </div>
          </div>
          <div class="card-actions">
            <div class="action">
					  	<paper-button on-click="_handleLeftButton">{{leftText}}</paper-button>
						  <paper-button id="rightButton" on-click="_handleRightButton">เลือก</paper-button>						
            </div>
          </div>
        </paper-card>
      </div>
    </template>
</dom-module>

<script>
  Polymer({
    is: 'host-person',
    properties: {
      hostList: Array,
      personList: Array,
  	  selectedHost: Object,
      multiple: {
        type: Boolean,
        value: false
      },
  	  state: String,
  	  leftText: {
  		  type: String,
  		  value: 'ยกเลิก'
  	  },
  	  pageIndex: Number,
  	  pageLimit: {
  		  type: Number,
  		  value: 10
  	  },
  	  requestQueue: Array,
  	  currentModel: String
    },
    ready: function() {
  	  this.state = "select_host";
  	  this.$.hostAjax.search('', this.pageIndex, this.pageLimit);
    },
    _hostToString: function(host){
  	  if(host.text){
  			return "(" + host.text + ")";
  		}
  		else{
  			return "";
  		}
  	},
  	_getID: function(obj){
  		var key = Object.keys(obj)[0];
  		return obj[key];
  	},
  	_getText: function(obj){
  		var key = Object.keys(obj)[1];
  		return obj[key];
  	},
  	_handleRadio: function(e){
  		this.selectedHost = {'id':e.target.name,'text':e.target.innerText.trim()};		
  		var radioGroup = this.$.list.querySelectorAll('paper-radio-button');
  		for(var i = 0; i < radioGroup.length; i++){
  			if(radioGroup[i].checked && radioGroup[i] != e.target){
  				radioGroup[i].checked = !radioGroup[i].checked;
  			}
  		}
  	},
  	_handleRightButton: function(e){
  		if(this.state == 'select_host'){			
  			this.multiple = true;
  			this._state_select_person();
  		}
  	},
  	_handleLeftButton: function(){
  		if(this.state == 'select_person'){
  			this.multiple = false;
  			this._state_select_host();
  		}
  		else{
  			// cancel
  		}
  	},
  	_state_select_host: function(){
  		this.leftText = "ยกเลิก";
  		this.$.rightButton.hidden = false;
  		this.state = 'select_host';
  		this.$.titleText.innerText = "เลือกโรงเรียน" + this._hostToString(this.selectedHost);
  	},
  	_state_select_person: function(){
  		this.leftText = "ย้อนกลับ";
  		this.$.rightButton.hidden = true;
  		this.state = 'select_person';
  		this.$.titleText.innerText = "เลือกนักเรียน" + this._hostToString(this.selectedHost);
  	},
  	_onHostSuccess: function(e){
  		if(e.detail){
  		  if(e.detail.data){
  		    var tmp = e.detail.data.map(function(obj){
  		      return {id:obj.id,text:obj.Name};
  		    });
  		    this.hostList = tmp.slice();
  		  }
  		}
  	},
  	_handleSearch: function(e){
  		this.pageIndex = 0;
  		this.$.hostAjax.search(e.target.value, this.pageIndex, this.pageLimit);
  	},
  	_handleCheckExist: function(){
  	  var url = decodeURI(this.$.checkExist.url);
  	  var where = JSON.parse(url.split('where=')[1]);
  	  var personID = where.and.filter(function(a){ return a.PersonID })[0].PersonID;
  	  this._updateStatus(personID, this.$.checkExist.lastResponse.count);
  	  this._generateRequest();
  	},
  	_updateStatus: function(id, count){
  	  this._hideShow('paper-spinner', id, false, 500);
  	  if(count == 0){
    	  this._hideShow('paper-fab', id, false, 500);
    	}
    	else{
    	  this._hideShow('paper-fab', id, true, 500);
    	}
  	  
  	  if(count > 0){
    	  this._hideShow('span', id, false, 500);
    	}
    	else{
    	  this._hideShow('span', id, true, 500);
    	}
  	},
  	_hideShow: function(selector, compare, isShow, timeout){
  	  var elements = this.$.itemDetails.querySelectorAll(selector);
  	  for(var i = 0; i < elements.length; i++){
    		if(elements[i].name == compare){
    		  if(selector == 'paper-spinner'){
    		    setTimeout(function(){ elements[i].active = isShow; }, timeout);
    		  }
    		  else{
    		    setTimeout(function(){ elements[i].hidden = isShow; }, timeout);
    		  }
    			break;
    		}
  		}
  	},
  	_generateRequest: function(){
  	  if(this.requestQueue){
  	    if(this.requestQueue.length > 0){
  	      var id = this.requestQueue.shift();
  	      var where = {"and":[{"HostID":this.selectedHost.id},{"PersonID":id}]};
      		this.$.checkExist.url = "/api/HostPeople/count?where=" + encodeURI(JSON.stringify(where));
      		this.$.checkExist.generateRequest();
  	    }
  	  }
  	},
  	_handleSave: function(e){
  	  var target = this._findUntil(e.target, 'paper-fab', 5);
  	  this._hideShow('paper-fab', target.name, true, 1);
  	  this._hideShow('paper-spinner', target.name, true, 1);
      
  	  this.$.saveAjax.url = "/api/HostPeople";
      this.$.saveAjax.body = JSON.stringify({
        "HostID": this.selectedHost.id,
        "PersonID": target.name,
        "StartDate": new Date()
      });
  	  this.$.saveAjax.generateRequest();
  	},
  	_handleAjaxSave: function(){
  	  if(this.$.saveAjax.lastResponse){
  	    var body = JSON.parse(this.$.saveAjax.body);
  	    this._updateStatus(body.PersonID, 1);
  	  }
  	},
  	_findUntil: function(element, expectTag, limitLoop){
      for(var i = 0; i < limitLoop; i++){
        if(element.localName == expectTag){
          return element;
        }
        else{
          element = element.parentNode;
        }
      }
      return null;
    },
    _personuiSuccess: function(e){
      var tmp = e.detail.map(function(obj){
  		  return {
  		    key:obj.id,
  		    text:obj.CID + ' ' + obj.Title + ' ' + obj.FirstName + ' ' + obj.LastName
  		  };
  		});
  		this.personList = tmp.slice();
      tmp = this.personList.map(function(obj){
  		  return obj.key;
  		});
  		this.requestQueue = tmp.slice();
  		this._generateRequest();
    }
  });
</script>