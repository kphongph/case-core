<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./attr-filter.html">
<link rel="import" href="./field-filter.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="ds-manager">
  <template>
    <iron-ajax id="getDescription" 
      auto
      url="{{url}}"
      handle-as="json"
      on-response="_handleDescription">
    </iron-ajax>

    <iron-ajax id="countAjax" 
      handle-as="json"
      on-response="_handleCount">
    </iron-ajax>

    <iron-ajax id="worker" 
      handle-as="json"
      on-response="_handleRequest">
    </iron-ajax>
    
    <template is="dom-repeat" as="model"
      items="{{_toArray(model_description.models)}}">
      <h2>Model: <span>{{model.name}}</span></h2>
      <h3>#Records: <span>{{records}}</span></h3>
      <h3>Properties</h3>
      <template is="dom-repeat" items="{{_toArray(model.value.properties)}}">
        <p>
        <attr-filter 
          model="{{model}}"
          description="{{item}}"
          on-filter="_handleAttrFilter"
          resource="{{resourcePath}}">
        </attr-filter>
        </p>
      </template>
    </template>
    
    <div>
      <field-filter on-filter="_handleFieldsFilter" fields="{{_getFields(model_description)}}"></field-filter>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is: 'ds-manager',
    properties: {
      model_description : {
        type: Object,
        notify: true
      },
      resourcePath : {
        type: String,
        computed: '_computeResourcePath(model_description)'
      },
      where : {
        type: Object,
        notify: true
      },
      records : {
        type: String,
      },
      selectedFields : {
        type: Array
      },
      fields : {
        type : Array,
        notify: true,
        computed: '_getFields(model_description)'
      },
      exampleResultUrl : {
        type: String,
        notify: true
      }
    },
    observers : [
      '_computeExampleResult(selectedFields)',
      '_computeExampleResult(where)'
    ],
    ready: function() {
    },
    _computeResourcePath: function(desc) {
      return desc.basePath+desc.resourcePath;
    },
    _computeReturnRecords: function(where) {
      if(where.and.length > 0){
        this.$.countAjax.url = this.resourcePath+'/count?where='+encodeURI(JSON.stringify(where));
        this.$.countAjax.generateRequest();
      } else {
        this.$.countAjax.url = this.resourcePath+'/count';
        this.$.countAjax.generateRequest();
      }
    },
    _handleDescription : function() {
      this.model_description = this.$.getDescription.lastResponse;
      this.where = {'and':[]};
      this._computeReturnRecords(this.where);
    },
    _handleAttrFilter : function(e) {
      var models = this._toArray(this.model_description.models);
      for(var i=0;i<models.length;i++) {
        if(e.detail.model.name == models[i].name) {
          this._generateQuery(this.model_description.models[models[i].name],e.detail);
        }
      }
    },
    _generateQuery : function(model,filter) {
      model.properties[filter.attr]['query'] = filter.query;
      var attr_and = [];
      for(var key in model.properties) {
        if(model.properties[key].query) {
          attr_and.push(model.properties[key].query);
        }
      }
      this.where = new Object({'and':attr_and});
      this._computeReturnRecords(this.where);
    },
    _toArray: function(obj) {
      return Object.keys(obj).map(function(key) {
        return {name:key,value:obj[key]};
      });
    },
    _propertyToString: function(obj) {
      return obj.name+' ('+obj.value.type+')';
    },
    _handleCount : function() {
      this.records = this.$.countAjax.lastResponse.count;
    },
    getResultUrl: function(limit){
      var fields = this.selectedFields;
      if(!fields){
        fields = [];
      }
      var where = this.where;
      if(!where){
        where = {};
      }
      if(limit){
        return this.resourcePath 
        + '?filter={"fields":' + JSON.stringify(fields) 
        + ',"limit":' + limit 
        + ',"where":' + encodeURI(JSON.stringify(where)) + '}';
      } else {
        return this.resourcePath 
        + '?filter={"fields":' + JSON.stringify(fields)
        + ',"where":' + encodeURI(JSON.stringify(where)) + '}';
      }
    },
    _computeExampleResult: function(where,selectedFields){
      var limit = 50;
      this.exampleResultUrl = this.getResultUrl(limit);
    },
    _getFields: function(model_description){
      var properties = this._toArray(model_description.models)[0].value.properties;
      if(properties){
        var tmp = [];
        for(var key in properties) {
          tmp.push(key);
        }
        return tmp;
      } else {
        return [];
      }
    },
    _handleFieldsFilter: function(e){
      this.selectedFields = e.detail.slice(0);
    }
  });
</script>
