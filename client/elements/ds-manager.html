<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./attr-filter.html">
<link rel="import" href="./field-filter.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">

<dom-module id="ds-manager">
  <style>
    .content{
      font-family: 'Roboto Regular', sans-serif;
    }
    .title{
      @apply(--layout-horizontal);
      padding-top: 20px;
    }
    .model{
      font-weight: bold;
      font-size: 150%;
    }
    .record{
      padding: 8px 0 0 10px;
    }
  </style>
  
  <template>
    <iron-ajax id="getDescription" 
      auto
      url="{{url}}"
      handle-as="json"
      on-response="_handleDescription">
    </iron-ajax>

    <iron-ajax id="countAjax" 
      handle-as="json"
      on-response="_handleCount">
    </iron-ajax>

    <iron-ajax id="worker" 
      handle-as="json"
      on-response="_handleRequest">
    </iron-ajax>
    
    <template is="dom-repeat" as="model"
      items="{{_toArray(model_description.models)}}">
      <div class="content">
        <div class="title">
          <div class="model">Model:<span>{{model.name}}</span></div>
          <div class="record">(<span>{{records}}</span> records)</div>
        </div>
        <div>
          <field-filter on-filter="_handleFieldsFilter" fields="{{_getFields(model_description)}}"></field-filter>
        </div>
        <h3>Properties</h3>
        <template is="dom-repeat" items="{{_toArray(model.value.properties)}}">
          <p>
          <attr-filter 
            model="{{model}}"
            description="{{item}}"
            on-filter="_handleAttrFilter"
            resource="{{resourcePath}}"
            on-attr-done="_handleAttrDone">
          </attr-filter>
          </p>
        </template>
      </div>
    </template>
    
  </template>
</dom-module>

<script>
  Polymer({
    is: 'ds-manager',
    properties: {
      model_description : {
        type: Object,
        notify: true
      },
      resourcePath : {
        type: String,
        computed: '_computeResourcePath(model_description)'
      },
      where : {
        type: Object,
        notify: true
      },
      records : {
        type: String,
      },
      selectedFields : {
        type: Array
      },
      fields : {
        type : Array,
        notify: true,
        computed: '_getFields(model_description)'
      },
      exampleResultUrl : {
        type: String,
        notify: true
      },
      json: {
        type: Object,
        notify: true
      }
    },
    observers : [
      '_computeExampleResult(selectedFields)',
      '_computeExampleResult(where)',
      '_computeJSON(exampleResultUrl)'
    ],
    ready: function() {
    },
    _computeResourcePath: function(desc) {
      return desc.basePath+desc.resourcePath;
    },
    _computeReturnRecords: function(where) {
      if(where.and.length > 0){
        this.$.countAjax.url = this.resourcePath+'/count?where='+encodeURI(JSON.stringify(where));
        this.$.countAjax.generateRequest();
      } else {
        this.$.countAjax.url = this.resourcePath+'/count';
        this.$.countAjax.generateRequest();
      }
    },
    _handleDescription : function() {
      this.model_description = this.$.getDescription.lastResponse;
      this.where = {'and':[]};
      this._computeReturnRecords(this.where);
    },
    _handleAttrFilter : function(e) {
      var models = this._toArray(this.model_description.models);
      for(var i=0;i<models.length;i++) {
        if(e.detail.model.name == models[i].name) {
          this._generateQuery(this.model_description.models[models[i].name],e.detail);
        }
      }
    },
    _generateQuery : function(model,filter) {
      model.properties[filter.attr]['query'] = filter.query;
      var attr_and = [];
      for(var key in model.properties) {
        if(model.properties[key].query) {
          attr_and.push(model.properties[key].query);
        }
      }
      this.where = new Object({'and':attr_and});
      this._computeReturnRecords(this.where);
    },
    _toArray: function(obj) {
      return Object.keys(obj).map(function(key) {
        return {name:key,value:obj[key]};
      });
    },
    _propertyToString: function(obj) {
      return obj.name+' ('+obj.value.type+')';
    },
    _handleCount : function() {
      this.records = this.$.countAjax.lastResponse.count;
      this.fire('done');
    },
    getResultUrl: function(limit, fields){
      if(!fields){
        fields = [];
      }
      var where = this.where;
      if(!where){
        where = {};
      }
      if(where.and){
        if(where.and.length == 0){
          where = {};
        }
      }
      if(limit){
        return this.resourcePath 
        + '?filter={"fields":' + JSON.stringify(fields) 
        + ',"limit":' + limit 
        + ',"where":' + encodeURI(JSON.stringify(where)) + '}';
      } else {
        return this.resourcePath 
        + '?filter={"fields":' + JSON.stringify(fields)
        + ',"where":' + encodeURI(JSON.stringify(where)) + '}';
      }
    },
    _computeExampleResult: function(where,selectedFields){
      var limit = 50;
      this.exampleResultUrl = this.getResultUrl(limit, this.fields);
    },
    _computeJSON: function(){
      var properties = [];
      if(this.where){
        for( var i = 0; i < this.where.and.length; i++){
          var property = null;
          var values = [];
          var andKey = Object.keys(this.where.and[i])[0];
          if(andKey == 'or'){
            for( var j = 0; j < this.where.and[i].or.length; j++){
              var obj = this.where.and[i].or[j];
              var key = Object.keys(obj)[0];
              if(!property){
                property = key;
              }
              if(obj[key]){
                if(obj[key].like){
                  values.push(obj[key].like.split('%')[1]);
                }
                else{
                  values.push(obj[key]);
                }
              }
            }
          }
          else if(andKey.indexOf('date') != -1){
            if(!property){
              property = andKey;
            }
            var dateType = Object.keys(this.where.and[i][andKey])[0];
            var inValue = this.where.and[i][andKey][dateType];
            if(inValue.length){ // date between
              values.push(inValue[0]);
              values.push(inValue[1]);
            }
            else{ // date gt
              values.push(inValue);
            }
          }
          var tmp = {};
          tmp[property] = values;
          properties.push(tmp);
        }
      }
      this.json = {'fields':this.selectedFields,'properties':properties};
    },
    _getFields: function(model_description){
      var properties = this._toArray(model_description.models)[0].value.properties;
      if(properties){
        var tmp = [];
        for(var key in properties) {
          tmp.push(key);
        }
        this.selectedFields = tmp.slice();
        return tmp;
      } else {
        this.selectedFields = [];
        return [];
      }
    },
    _handleFieldsFilter: function(e){
      this.selectedFields = e.detail.slice(0);
      this.fire('finish');
    },
    doJob: function(job){
      // do work
      var key = Object.keys(job.value)[0];
      if(key == 'field'){
        var target = document.getElementById(job.id).getElementsByTagName('field-filter')[0];
        target.doJob(job);
      }
      else if(key == 'property'){
        var data = job.value.property;
        var targets = document.getElementById(job.id).getElementsByTagName('attr-filter');
        for( var i = 0; i < targets.length; i++){
          var text = (targets[i].innerText.split('(')[0]).trim();
          if(text == data.key){
            targets[i].doJob(job);
            break;
          }
        }
      }
    },
    _handleAttrDone: function(){
      this.fire('finish');
    }
  });
</script>
