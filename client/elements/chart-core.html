<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="chart-core">

  <style>
    :host {
      @apply(--layout-vertical);
    }
    .m-container{
      background-color: #FFFFFF;
      width: 100%;
      height: 450px;
      min-width: 500;
    }
    .container{
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
      height: 400px;
    }
    .right{
      top: 5px;
      position: absolute;
      right: 15px;
    }
    .list{
      position: absolute;
      right: 15px;
      width: 150px;
      height: 250px;
      overflow-y: scroll;
    }
    paper-item{
      cursor: pointer;
    }
    paper-item:hover{
      background-color: rgba(0, 0, 0, 0.2);
    }
    google-chart{
      height: 400px;
      overflow-y: scroll;
    }
  </style>

  <template>
    <paper-material elevation="1" class="m-container" id="panel">
      <div class="container">
        <div>
          <google-chart
             id="chart"
             type='table'
             options='{"legend": "bottom"}'
             cols='{{cols}}'
             data='{{data}}'
            rows='{{rows}}'>
          </google-chart>
          <div class="right">
            <paper-fab id="menu" mini icon="assessment" on-click="_menuClicked"></paper-fab>
            <div hidden$="{{!showMenu}}">
              <paper-material elevation="1" class="list">
                <template is="dom-repeat" items="{{chartTypes}}">
                  <paper-item on-click="_typeChanged" value$="{{item}}">{{item}}</paper-item>
                </template>
              </paper-material>
            </div>
          </div>
        </div>
      </div>
    </paper-material>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'chart-core',
    ready: function(){
      if(!this.chartTypes){
        this.$.chart._loadPackageByChartType();
        this.chartTypes = Object.keys(this.$.chart._packages);
      }
      this.showMenu = false;
      this.data = [["Month", "Days"], ["Jan", 31], ["Feb", 28], ["Mar", 31]];
    },
    properties: {
      action: {
        type: String,
        observer:'_actionChanged'
      },
      cols: Array,
      rows: Array,
      data: Array,
      dataArray: {
        type: Array,
        notify: true,
        observer:'_dataArrayChanged'
      },
      chartTypes: Array,
      showMenu: Boolean
    },
    _menuClicked: function(){
      this.showMenu = !this.showMenu;
    },
    _typeChanged: function(e){
      var type = e.target.getAttribute('value');
      var dom = Polymer.dom(this.$.chart).node;
      this.$.chart.type = type;
      this.$.chart._readyForAction();
      this._menuClicked();
      this.$.chart.style.width = this.$.panel.parentNode.clientWidth + 'px';
    },
    clear: function(){
      this.rows = [[null, null]];
      this.$.chart.rows = this.rows;
      this.$.chart._loadData();
    },
    _actionChanged: function() {
      var data = JSON.parse(this.action);
      if(data){
        if(data.operation == 'insert'){
          if(this.rows.length > 0){
            if(this.rows[0][0] === null){
              this.rows = [];
            }
          }
          this.rows.push([data.target.text, data.target.value]);
          this.$.chart.rows = this.rows;
          this.$.chart._loadData();
        }
        else if(data.operation == 'delete'){
          for(var i=0; i<this.rows.length; i++){
            if(this.rows[i][0] == data.target.text){
              this.rows.splice(i, 1);
              if(this.rows.length == 0){
                this.rows.push([null, null]);
              }
              this.$.chart.rows = this.rows;
              this.$.chart._loadData();
              break;
            }
          }
        }
      }
    },
    _dataArrayChanged: function(){
      if(this.dataArray){
        if(this.dataArray.length > 0){
          this.generateChartData(this.dataArray);
        }
      }
    },
    generateChartData: function(data){
      var cols = [];
      var dataChart = [];
      var keys = Object.keys(data[0]);
      if(keys){
        for(var i=0; i < keys.length; i++){
          cols.push(keys[i]);
        }
        dataChart.push(cols);
        for(var i=0; i < data.length; i++){
          var tmp = [];
          for(var j=0; j < keys.length; j++){
            tmp.push(data[i][keys[j]]);
          }
          dataChart.push(tmp);
        }
        this.data = dataChart;
        this.$.chart.style.width = this.$.panel.parentNode.clientWidth + 'px';
      }
    }
  });
</script>