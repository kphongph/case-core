<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="lp-query.html">
<link rel="import" href="chart-core.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="i-report">
  <style>
    :host {
      @apply(--layout-horizontal);
    }
    .container{
      @apply(--layout-horizontal);
      width: 100%;
      height: 450px;
      background-color: #FFFFFF;
    }
    .list{
      width: 40%;
      height: 100%;
    }
    .list-body{
      margin: 0px 0px 0px 5px;
      height: 85%;
      overflow-y: scroll;
    }
    .list paper-checkbox{
      padding-bottom: 10px;
    }
    .ichart{
      width: 60%;
    }
    .header{
      background-color: #42A5F5;
      padding: 16px 0px 0px 16px;
      color: #FFFFFF;
      height: 40px;
    }
  </style>
  <template>
    <iron-ajax id="ajax" last-response="{{services}}"></iron-ajax>
    <div class="container">
      <div class="list">
        <div class="header" flex>รายการ</div>
        <div class="list-body">
          <template is="dom-repeat" items="{{services}}">
            <paper-checkbox 
              on-change="_checkChanged"
              ds$="{{item.ds}}" 
              where$="{{item.where}}" 
              filter$="{{item.filter}}">{{item.text}}</paper-checkbox><br />
          </template>
        </div>
      </div>
      <div class="ichart">
        <chart-core action="{{actionString}}" cols="{{cols}}" rows="{{rows}}"></chart-core>
      </div>
    </div>
    <lp-query 
      ds="{{ds}}" where="{{where}}" filter="{{filter}}" result="{{result}}">
    </lp-query>
 </template>
</dom-module>

<script>
  Polymer({
    is:'i-report',
    ready: function() {
      this.cols = [
          {label: "Topic(key)", type: "string"},
          {label: "Result(value)", type: "number"}
        ];
      this.rows = [[null, null]];
      this.hostid = "3720140208";
    },
    properties: {
     actionString: {
        type: String
      },
      hostid: String,
      cols: Object,
      ds: String,
      url: {
        type: String,
        observer: '_urlChanged'
      },
      rows: Object,
      where: Object,
      services: Array,
      cmservices: Object,
      action: {
        type: Object,
        value: {
          target: {
            id: String,
            value: String,
            text: String
          },
          operation: {
            type: String
          }
        }
      },
      result: {
        type: Object,
        observer: '_resultChanged'
      }
    },
    _urlChanged: function(){
      if(this.url){
        this.$.ajax.url = this.url;
        this.$.ajax.generateRequest();
      }
    },
    _resultChanged: function(){
      if(this.result){
        var key = Object.keys(this.result)[0];
        if(key == 0){
          this.action.target.value = this.result[key][Object.keys(this.result[key])];
        }
        else{
          this.action.target.value = this.result[key];
        }
        this.actionString = JSON.stringify(this.action);
      }
    },
    _checkChanged: function(e) {
      var checkbox = e.target;
      this.action.target.id = checkbox.getAttribute('value');
      this.action.target.text = Polymer.dom(checkbox).textContent;
      this.action.operation = 'insert';
      if(!checkbox.checked){
        this.action.operation = 'delete';
        this.actionString = JSON.stringify(this.action);
      }
      else{
        var ds = checkbox.getAttribute('ds');
        if(ds){
          if(ds == 'cmservices'){
            this.action.target.value = this.evalSelector(
              checkbox.getAttribute('where'), JSON.parse(this.cmservices));
            this.actionString = JSON.stringify(this.action);
          }
          else{
            this.ds = ds;
            var where = checkbox.getAttribute('where');
            var filter = checkbox.getAttribute('filter');
            this.where = null;
            this.filter = null;
            if(filter){
              this.filter = JSON.parse(filter.replace("_hostid", this.hostid));
            }
            if(where){
              this.where = JSON.parse(where.replace("_hostid", this.hostid));
            }
          }
        }
      }
    },
    evalSelector: function(selector, jsonData){
      var tokens = this.splitter(selector);
      var resultStr = "selector";
      for(var i = 0; i < tokens.length; i++){
        resultStr += '.replace("' + tokens[i] + '", ' + 'Number(eval("jsonData" + "' + tokens[i] + '")))';
      }
      return eval(eval(resultStr));
    },
    splitter: function(text){
      var separators = [' ', '\\\+', '-', '\\\(', '\\\)', '\\*', '/', ':', '\\\?'];
      var tokens = text.split(new RegExp(separators.join('|'), 'g'));
      return tokens.filter(function(n){ return n != "" });
    }
  });
</script>
