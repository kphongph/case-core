<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/polymer-cookie/polymer-cookie.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<polymer-element name="ltc-user">

<template>
  <style>
    :host {
      display:block;
    }
  </style>

  <polymer-cookie name="access_token" id="token"></polymer-cookie>
  <polymer-cookie name="userId" id="userId"></polymer-cookie>

  <core-ajax 
    auto
    handleAs="json" 
    url="/account"
    response="{{user}}"> 
  </core-ajax>

  <core-ajax 
    id="signinAjax"
    url="/auth/google"
    core-response="{{signinResponse}}">
  </core-ajax>

  <core-ajax 
    id="signoutAjax"
    handleAs="json" 
    method="POST"
    url="/api/users/logout"
    core-response="{{signoutResponse}}">
  </core-ajax>

  <core-ajax 
    id="logoutAjax"
    handleAs="json" 
    url="/auth/logout"
    core-response="{{logoutResponse}}">
  </core-ajax>
  
  <div layout horizontal>
    
    <template if="{{unauthorized}}">
      <a href="/auth/google">
        <img src="/images/White-signin_Medium_base_32dp.png"></img>
      </a>
    </template>

    <template if="{{email}}">
      <div layout horizontal center>
        <div>{{email}} - {{displayName}}</div>
        <div>
          <paper-button on-tap="{{signout}}">Sign out</paper-button>
        </div>
      </div>
    </template>
  </div>

</template>

<script>
  Polymer('ltc-user', {
    unauthorized:true,
    userChanged: function(oldVal, newVal) {
      if(!newVal) return;
      if(newVal.status == 401) {
        this.unauthorized = true;
      } else {
        if(newVal.username) {
          this.unauthorized = false;
          this.email = newVal.email;
          if(newVal.profiles.length > 0) {
            this.displayName = newVal.profiles[0].profile.displayName;
          }
        }
      }
    },
    signin : function() {
      this.$.signinAjax.go();
    },
    signout: function() {
      this.$.logoutAjax.go();
      this.$.signoutAjax.go();
      this.$.token.deleteCookie();
      this.$.userId.deleteCookie();
      this.unauthorized=true;
      this.email = null;
      this.displayName = null;
    }
  });
</script>
</polymer>
