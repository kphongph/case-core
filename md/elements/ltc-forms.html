<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-menu/core-submenu.html">
<link rel="import" href="../bower_components/core-selector/core-selector.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/case-form/case-form.html">

<link rel="import" href="forms/ltc-form-form33.html">
<link rel="import" href="forms/ltc-form-form10.html">
<link rel="import" href="forms/ltc-form-form11.html">
<link rel="import" href="forms/ltc-form-form12.html">
<link rel="import" href="forms/ltc-form-form13.html">
<link rel="import" href="forms/ltc-form-form14.html">
<link rel="import" href="forms/ltc-form-form15.html">
<link rel="import" href="forms/ltc-form-form16.html">
<link rel="import" href="forms/ltc-form-form21.html">

<polymer-element name="ltc-forms" attributes="person">

<template>
  <style>

:host {
  display:block;
  overflow:auto;
}

.formList {
  padding:10px;
  margin:10px;
}

core-item {
  padding-left:10px;         
}

tmp.core-item.core-selected {
 color: #fff;
 background-color: #03A9F4;
}

core-item.core-selected {
 background-color: #eeeeee;
}

.selectedType {
  margin:10px;
}

core-submenu::shadow #submenu {
  margin-left: 0px;
}

#formViews > * {
  display: none;
}

#formViews > .core-selected {
  display: block;
}
  </style>

  <core-ajax 
    id="getForms"
    handleAs="json" 
    loading="{{getFormsLoading}}"
    response="{{ajaxForms}}"> 
  </core-ajax>

  <core-toolbar>
    <div horizontal layout center>
      <div>
        <paper-icon-button icon="arrow-back" on-tap="{{backAction}}" 
        </paper-icon-button>
      </div>
      <div flex>
        {{person.CID}} {{person.FirstName}} {{person.LastName}}
      </div>
    </div>
  </core-toolbar>

  <core-animated-pages selected="{{selected}}">
    <div name="menu">
      <core-menu selected="{{formType}}">
        <template repeat="{{form in formList}}">
          <core-item name="{{form.name}}" 
            label="{{form.name}}">  
          </core-item>
        </template>
      </core-menu>
    </div>
    <div name="formList" class="formList">
      <div layout vertical>
        <div>
          {{formType}}
          <paper-spinner class="blue" active?="{{getFormsLoading}}">
          </paper-spinner>
        </div>
        <div>
            <core-menu selected="{{selectedFormId}}">
              <template repeat="{{doc in ajaxForms}}">
                <core-item name="{{doc.id}}" 
                  label="{{doc.createdDate | date}}">
                </core-item>
              </template>
            </core-menu>
        </div>
        <div>
          <template if="{{formType}}">
            <paper-button raised on-tap="{{createForm}}">
              สร้างแบบประเมินใหม่
            </paper-button>
          </template>
        </div>
      </div>
    </div>
    <div name="formPanel">
      <core-selector id="formViews" notap 
        selected="{{selectedForm.hash}}">
        <ltc-form-form33 name="form33" json="elements/forms/form33.json"
           active?="{{selectedForm.hash == 'form33'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form33>
        <ltc-form-form10 name="form10" json="elements/forms/form10.json"
           active?="{{selectedForm.hash == 'form10'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form10>
        <ltc-form-form11 name="form11" json="elements/forms/form11.json"
           active?="{{selectedForm.hash == 'form11'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form11>
        <ltc-form-form12 name="form12" json="elements/forms/form12.json"
           active?="{{selectedForm.hash == 'form12'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form12>
        <ltc-form-form13 name="form13" json="elements/forms/form13.json"
           active?="{{selectedForm.hash == 'form13'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form13>
        <ltc-form-form14 name="form14" json="elements/forms/form14.json"
           active?="{{selectedForm.hash == 'form14'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form14>
        <ltc-form-form15 name="form15" json="elements/forms/form15.json"
           active?="{{selectedForm.hash == 'form15'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form15>
        <ltc-form-form16 name="form16" json="elements/forms/form16.json"
           active?="{{selectedForm.hash == 'form16'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form16>
        <ltc-form-form21 name="form21" json="elements/forms/form21.json"
           active?="{{selectedForm.hash == 'form21'}}"
           form="{{selectedForm}}" owner="{{person}}">
        </ltc-form-form21>
      </core-selector>
    </div>
  </core-animated-pages>
  
</template>

<script>
  Polymer('ltc-forms', {
    loading:false,
    selected: 'menu',
    eventDelegates: {
      'form-deleted':'showFormList'
    },
    formList: [
      {hash:'form33', name:'แบบคัดกรองเพื่อจำแนกกลุ่มผู้สูงอายุตามศักยภาพ'},
      {hash:'form10', name:'แบบประเมินผู้สูงอายุที่ต้องได้รับการดูแลระยะยาว'},
      {hash:'form11', name:'ข้อมูลเบื้องต้นของผู้สูงอายุ'},
      {hash:'form12', name:'แบบประเมินด้านสังคม'},
      {hash:'form13', name:'แบบประเมินความสามารถในการทำกิจวัตรประจำวัน'},
      {hash:'form14', name:'แบบประเมินสภาพสมอง'},
      {hash:'form15', name:'แบบประเมินภาวะกลืนลำบาก'},
      {hash:'form16', name:'แบบประเมินภาวะซึมเศร้าในช่วง 2 สัปดาห์ที่ผ่านมารวมทั้งวันนี้'},
      {hash:'form21', name:'ความต้องการในการดูแลทางการแพทย์'}
    ],
    backAction: function() {
      if(this.selected == "menu") {
        this.fire('person');
      } else {
        if(this.selected == "formPanel") {
          // trick form type changed
          this.showFormList();
        } else {
          this.selected="menu";
          this.formType = null;
        }
      }
    },
    showFormList : function() {
      this.selected="formList";
      this.selectedFormId = null;
      this.updateFormList();
    },
    date: function(val) {
      return new Date(val);
    },
    updateFormList : function() {
      var query = "../api/people/"+this.person.id+"/forms";
      query+= "?filter[fields][id]=true";
      query+= "&filter[where][name]="+this.formType;
      query+= "&filter[fields][name]=true";
      query+= "&filter[fields][createdDate]=true";
      this.$.getForms.url = query;
      this.$.getForms.go();
    },
    formTypeChanged : function(oldVal, newVal) {
      if(newVal && this.person) {
        var query = "../api/people/"+this.person.id+"/forms";
        query+= "?filter[fields][id]=true";
        query+= "&filter[where][name]="+newVal;
        query+= "&filter[fields][name]=true";
        query+= "&filter[fields][createdDate]=true";
        this.$.getForms.url = query;
        this.selected="formList";
        this.$.getForms.go();
      }
    },
    personChanged: function(oldVal, newVal) {
      if(newVal) {
        var query = "../api/people/"+newVal.id+"/forms";
        query+= "?filter[fields][id]=true";
        query+= "&filter[fields][name]=true";
        query+= "&filter[fields][createdDate]=true";
        this.$.getForms.url = query;
        this.$.getForms.go();
      }
    },
    selectedFormIdChanged: function(oldVal, newVal) {
     if(newVal && this.ajaxForms) {
       for(var i=0;i<this.ajaxForms.length;i++) {
         if(newVal == this.ajaxForms[i].id) {
           this.selectedForm = this.ajaxForms[i];
           this.selectedForm['hash']=null;
           for(var j=0;j<this.formList.length;j++) {
             if(this.formList[j].name == this.selectedForm.name) {
               this.selectedForm['hash']=this.formList[j].hash;
               this.selected="formPanel";
               break;
             }
           }
           break;
         }
       }
     }
    },
    createForm : function() {
      if(this.formType) {
        for(var i=0;i<this.formList.length;i++) {
          if(this.formList[i].name == this.formType) {
            this.selectedForm = this.formList[i];
            this.selected="formPanel";
            break;
          }
        }
      }
    }
  });
</script>
</polymer>
