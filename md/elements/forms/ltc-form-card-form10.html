<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/case-form/case-form.html">

<link rel="import" href="ltc-form-card-toolbar.html">

<polymer-element name="ltc-form-card-form10" attributes="form"> 

<template>
  <style>
    :host {
      display:block;
    }
    core-selector > * {
      display:none;
    }
    paper-icon-button { 
      height:16px;
      width:16px;
    }
    core-selector > .core-selected {
      display:block;
    }

    #panel.active {
      opacity:1;
    }
    #panel {
      opacity:0.6;
      padding:5px;
      padding-left:10px;
      margin:5px;
    }
    .result {
      padding:5px;
      marging:5px;
      background-color: #03A9F4;
      color: #fff;
    }
    .review {
      padding:5px;
      margin:5px;
    }
    .reviewAnswer {
      background:#eee;
      padding:5px;
    }
  </style>

  <core-ajax
    id="getOptions"
    handleAs="json"
    loading="{{loading}}"
    on-core-response="{{optionsLoaded}}">
  </core-ajax>


  <paper-shadow id="panel" z="1" class="{{ {active:active} | tokenList}}">
    <div layout vertical>
      <div>
        <ltc-form-card-toolbar 
           id="formToolbar"
           form="{{form}}" 
           document="{{document}}" 
           active="{{active}}">
        </ltc-form-card-toolbar>
      </div>
   
      <div hidden?="{{!active}}" layout vertical>
        <core-selector selected="{{selected}}">
          <div name="result">
            <div class="result" hidden?="{{!document.result}}">
              {{document.result.label}}
            </div>
            <template repeat="{{model in document.questions}}">
              <div layout vertical class="review">
                <div>
                  {{model.question}}
                </div>
                <div class="reviewAnswer">
                  <core-selector id="reviewAnswer" selected="{{model.type}}">
                    <div name="single-select">
                     <span hidden?="{{!model.options[model.answer].label.date}}">
                     {{model.options[model.answer].label.date | date('yyyy-MM-dd HH:mm')}} 
                     --
                     </span> 
                     {{model.options[model.answer].label.text}} 
                    </div>
                  </core-selector>
                </div>
              </div>
            </template>
          </div>
          <div name="form">
            <case-form id="caseForm" 
              form="{{jsonForm}}"
              filled="{{filledForm}}">
            </case-form>
          </div>
        </core-selector>
      </div>
    </div>
  </paper-shadow>
</template>

<script>
  Polymer('ltc-form-card-form10', {
    active : false,
    selected:'result',
    filledForm:null,
    eventDelegates : {
      'toggle-form':'toggleForm'
    },
    toggle : function() {
      this.active = !this.active;
      if(this.active) {
        this.$.formToolbar.getForm();
        this.icon='expand-less';
      } else {
        this.icon='expand-more';
      }
    },
    documentChanged: function(oldVal, newVal) {
      if(newVal && newVal.hash) {
        this.$.caseForm.src = 'elements/forms/'+newVal.hash+'.json';
        this.getOptions();
      }
    },
    filledFormChanged: function(oldVal, newVal) {
      if(newVal) {
        for(var key in newVal) {
          this.document[key] = JSON.parse(JSON.stringify(newVal[key]));
        }
        this.$.formToolbar.updateForm();
        this.toggleForm();
        this.filledForm = null;    
      }
    },
    toggleForm: function() {
     if(this.selected=='form') {
       this.selected='result';
     } else {
       this.selected='form';
     }
    },
    getOptions: function() {
      this.$.getOptions.url = "../api/people/"+
      this.document.ownerId+"/forms?"+
        "filter[fields][name]=true&"+
        "filter[fields][id]=true&"+
        "filter[fields][result]=true&"+
        "filter[fields][updatedDate]=true&"+
        "filter[fields][createdDate]=true";
      this.$.getOptions.go();
    },
    jsonFormChanged: function(oldVal, newVal) {
      if(newVal) {
        this.getOptions();
      }
    },
    optionsLoaded:function() {
      var response = this.$.getOptions.response;
      if(!response) return;
      var tmpForm = this.jsonForm;
      for(var i=0;i<tmpForm.questions.length;i++) {
        var question = tmpForm.questions[i];
        question.options =[];
        for(var j=0;j<response.length;j++) {
          if(question.question == response[j].name) {
            var obj = {};
            obj['label']= new Date(response[j].updatedDate);
            obj['id']=response[j].id;
            question.options.push(obj);
          }
        }
      }
      if(this.document && this.document.questions) {
        for(var i=0;i<this.document.questions.length;i++) {
          var question = this.document.questions[i];
          if('answer' in question) {
            var answer_id = question.options[question.answer].id;
            for(var j=0;j<response.length;j++) {
              if(answer_id == response[j].id) {
                question.options[question.answer]['label'] = {
                  text:response[j].result.label,
                  date:response[j].updatedDate}
                break;
              }
            }
          }
        }
      }
    }
  });
</script>
</polymer>
